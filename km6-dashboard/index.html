<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>KM6 Sales Dashboard</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    body{font-family:Arial,Helvetica,sans-serif;background:#f8f9fa;margin:0}
    header{background:#fdb913;color:#111;padding:14px 22px;display:flex;align-items:center;justify-content:space-between}
    .logo h1{font-size:18px;margin:0}
    .header-right h2{display:inline-block;margin:0 12px;font-size:16px}
    .header-right a{color:#111;text-decoration:none}
    .menu-container{position:relative;display:inline-block;margin-left:6px}
    .menu-icon{font-size:22px;cursor:pointer;user-select:none}
    .dropdown-menu{display:none;position:absolute;right:0;top:28px;background:#fff;width:210px;border-radius:10px;box-shadow:0 8px 18px rgba(0,0,0,.15);overflow:hidden;z-index:999}
    .dropdown-menu a{display:flex;gap:8px;align-items:center;padding:11px 14px;color:#222;text-decoration:none}
    .dropdown-menu a:hover{background:#f3f4f6}
    h2{color:#00843d;text-align:center;margin:18px 0}
    .summary h2 .date{color:#d32f2f}
    .info{text-align:center}
    .compare-section{width:95%;max-width:1100px;margin:18px auto 8px}
    .compare-cards{display:flex;gap:14px;justify-content:center;flex-wrap:wrap}
    .card{background:#fff;border-radius:12px;box-shadow:0 2px 6px rgba(0,0,0,.08);padding:18px 18px 16px;width:300px;text-align:center}
    .card h3{color:#00843d;margin:0 0 10px}
    .up{color:#00843d;font-weight:700}
    .down{color:#c62828;font-weight:700}
    .updated-time{font-size:.9em;color:#555;text-align:center;margin:6px 0 0}
    .table-section,.table-group{width:95%;max-width:1300px;margin:18px auto}
    .table-group h2{display:flex;align-items:center;gap:8px}
    .table-container{width:100%;overflow-x:auto;-webkit-overflow-scrolling:touch}
    table{width:100%;border-collapse:collapse;min-width:900px}
    th,td{padding:10px 8px;text-align:left;white-space:nowrap}
    th{background:#00843d;color:#fff}
    .total td{background:#eef8e9;font-weight:700}
  </style>
</head>
<body>
  <!-- Header -->
  <header class="header">
    <div class="logo"><h1>KM6 General Merchandise</h1></div>
    <div class="header-right">
      <h2><a href="#" id="totalSalesLink">Total Sales</a></h2>
      <h2><a href="#" id="dspSalesLink">DSP-Sales</a></h2>
      <h2><a href="#" id="focus30Link">Focus 30</a></h2>

      <!-- Ordered Menu: Settings ‚Üí Upload ‚Üí Logout -->
      <div class="menu-container">
        <div class="menu-icon">‚ò∞</div>
        <div class="dropdown-menu" id="dropdownMenu">
          <a href="settings.html">‚öôÔ∏è Settings</a>
          <a href="upload.html">üü¶ Upload Excel File</a>
          <a href="logout.html" id="logoutLink">üîí Log Out</a>
        </div>
      </div>
    </div>
  </header>

  <!-- KPIs -->
  <section class="summary">
    <h2>Daily Sales as of <span class="date">--</span></h2>
    <div class="info">
      <p>
        <strong>Selling Days:</strong> <span id="sellingDays">0</span> &nbsp;|&nbsp;
        <strong>Actual Days:</strong> <span id="actualDays">0</span> &nbsp;|&nbsp;
        <strong>Progress:</strong> <span id="progressPct">0%</span> &nbsp;|&nbsp;
        <strong>Remaining Days:</strong> <span id="remainingDays">0</span>
      </p>
    </div>
  </section>

  <!-- Daily Sales Current vs Previous -->
  <section class="compare-section">
    <h2>Daily Sales Current vs Previous</h2>
    <div class="compare-cards">
      <div class="card">
        <h3>Total KM6</h3>
        <p><strong>Previous Sales:</strong> <span id="prevKM6">-</span></p>
        <p><strong>Current Sales:</strong> <span id="currKM6">-</span></p>
        <p id="changeKM6">-</p>
      </div>
      <div class="card">
        <h3>Total Baguio</h3>
        <p><strong>Previous Sales:</strong> <span id="prevBaguio">-</span></p>
        <p><strong>Current Sales:</strong> <span id="currBaguio">-</span></p>
        <p id="changeBaguio">-</p>
      </div>
      <div class="card">
        <h3>Total La Union</h3>
        <p><strong>Previous Sales:</strong> <span id="prevLU">-</span></p>
        <p><strong>Current Sales:</strong> <span id="currLU">-</span></p>
        <p id="changeLU">-</p>
      </div>
    </div>
  </section>

  <p class="updated-time" id="lastUpdated">Last updated: --</p>

  <!-- Branch Summary -->
  <section class="table-section">
    <h2>Branch Summary</h2>
    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>Branch</th><th>Gross</th><th>Rejection</th><th>B.O Amount</th><th>Net Sales</th>
            <th>Target</th><th>%</th><th>Balance</th>
          </tr>
        </thead>
        <tbody id="branchSummary">
          <tr>
            <td>Baguio</td><td id="km6Gross">-</td><td id="km6Reject">-</td><td id="km6BO">-</td><td id="km6Net">-</td>
            <td id="km6Target">-</td><td id="km6Pct">-</td><td id="km6Bal">-</td>
          </tr>
          <tr>
            <td>La Union</td><td id="kmlGross">-</td><td id="kmlReject">-</td><td id="kmlBO">-</td><td id="kmlNet">-</td>
            <td id="kmlTarget">-</td><td id="kmlPct">-</td><td id="kmlBal">-</td>
          </tr>
          <tr class="total">
            <td><strong>Total KM6</strong></td>
            <td id="totGross">-</td><td id="totReject">-</td><td id="totBO">-</td><td id="totNet">-</td>
            <td id="totTarget">-</td><td id="totPct">-</td><td id="totBal">-</td>
          </tr>
        </tbody>
      </table>
    </div>
  </section>

  <!-- FS Tables -->
  <section class="table-group">
    <h2><span style="color:#f0b400">‚îÇ</span> Total KCM</h2>
    <div class="table-container">
      <table>
        <thead><tr><th>KCM</th><th>Gross</th><th>Rejection</th><th>B.O AMOUNT</th><th>Net Sales</th><th>Target</th><th>%</th><th>Balance</th></tr></thead>
        <tbody id="tblKCM">
          <tr><td>Jim Russel Peralta</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td></tr>
          <tr><td>Judy Ann Mabanta</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td></tr>
          <tr><td>Gilbert Aquino</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td></tr>
          <tr><td>Roderick Dacay</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td></tr>
          <tr><td>Gyver Gano</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td></tr>
          <tr class="total"><td><strong>Total KCM</strong></td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td></tr>
        </tbody>
      </table>
    </div>
  </section>

  <section class="table-group">
    <h2 style="color:#b71c1c">Tertiary La Union (KML)</h2>
    <div class="table-container">
      <table>
        <thead><tr><th>Name</th><th>Gross</th><th>Rejection</th><th>B.O AMOUNT</th><th>Net Sales</th><th>Target</th><th>%</th><th>Balance</th></tr></thead>
        <tbody id="tblLU">
          <tr><td>Gemma Jacaban</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td></tr>
          <tr><td>Jovelyn Castro</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td></tr>
          <tr class="total"><td><strong>Total LU</strong></td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td></tr>
        </tbody>
      </table>
    </div>
  </section>

  <section class="table-group">
    <h2><span style="color:#f0b400">‚îÇ</span> Tertiary Baguio (KM6)</h2>
    <div class="table-container">
      <table>
        <thead><tr><th>Name</th><th>Gross</th><th>Rejection</th><th>B.O AMOUNT</th><th>Net Sales</th><th>Target</th><th>%</th><th>Balance</th></tr></thead>
        <tbody id="tblBG">
          <tr><td>Jehu Romero</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td></tr>
          <tr><td>Mc Ardel Cachicho</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td></tr>
          <tr><td>Rocky Fowaya</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td></tr>
          <tr class="total"><td><strong>Total Baguio</strong></td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td></tr>
        </tbody>
      </table>
    </div>
  </section>
<button onclick="restoreDashboardFromCloud()" style="margin:10px; padding:5px 10px; background:#00897B; color:white; border:none; border-radius:6px;">
  üîÑ Sync from Cloud
</button>
<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore-compat.js"></script>
<script>
  // -----------------------------------------------------------
  // üî• FIREBASE INITIALIZATION
  // -----------------------------------------------------------
  const firebaseConfig = {
    apiKey: "AIzaSyCStpCWdRO770N4SpH3GKYwp9pg1kP6_O4",
    authDomain: "km6-dashboard.firebaseapp.com",
    projectId: "km6-dashboard",
    storageBucket: "km6-dashboard.appspot.com",
    messagingSenderId: "309068846407",
    appId: "1:309068846407:web:68d51a21f6ab238fa1a862",
  };
  if (firebase.apps.length === 0) firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
async function restoreDashboardFromCloud(force = false) {
  try {
    console.log("üì° Checking Firestore for saved dashboard data...");
    const docRef = db.collection("km6_dashboard_data").doc("dashboardTotals");
    const snapshot = await docRef.get();

    if (!snapshot.exists) {
      console.warn("‚ö†Ô∏è No dashboardTotals document found in Firestore.");
      return;
    }

    const data = snapshot.data();
    console.log("‚úÖ Cloud data loaded:", data);

    // If not forced and localStorage already has matching updated time, skip
    const localUpdated = JSON.parse(localStorage.getItem("lastSyncTime") || "null");
    if (!force && localUpdated === data.updated) {
      console.log("üü¢ Already up to date ‚Äî no restore needed.");
      return;
    }

    // ‚úÖ Restore all datasets
    if (data.dataweb) localStorage.setItem("dataweb", JSON.stringify(data.dataweb));
    if (data.pnetinv) localStorage.setItem("pnetinv", JSON.stringify(data.pnetinv));
    if (data.invoicedate) localStorage.setItem("invoicedate", JSON.stringify(data.invoicedate));
    if (data.fsTotals) localStorage.setItem("fsTotals", JSON.stringify(data.fsTotals));
    if (data.targets) localStorage.setItem("targets", JSON.stringify(data.targets));
    if (data.overall) localStorage.setItem("overall", JSON.stringify(data.overall));

    localStorage.setItem("lastSyncTime", JSON.stringify(data.updated));

    // ‚úÖ Refresh all dashboard components
    renderDailySales();
    computeBranchSummary();
    renderFSTables();
    autoSumTotals();
    updateBranchTargets();
    updateBranchSummaryCalculations();

    // ‚úÖ Update timestamp
    const label = document.getElementById("lastUpdated");
    if (label)
      label.textContent = "Last updated: " + (data.updated || new Date().toLocaleString());

    console.log("üéØ Dashboard restored and refreshed successfully!");
  } catch (err) {
    console.error("‚ùå Error restoring data from Firestore:", err);
  }
}

// üü¢ AUTO RUN on page load (detect if mobile has no data)
window.addEventListener("load", async () => {
  const hasData =
    localStorage.getItem("dataweb") &&
    localStorage.getItem("pnetinv") &&
    localStorage.getItem("invoicedate");

  if (!hasData) {
    console.log("üì± No local data found ‚Äî restoring from Firebase...");
    await restoreDashboardFromCloud();
  } else {
    console.log("üíæ Local data found ‚Äî skipping restore.");
  }
});
  // -----------------------------------------------------------
  // üßÆ HELPERS
  // -----------------------------------------------------------
  const fmt = n => Number(n || 0).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
  const num = v => parseFloat(String(v || "0").replace(/[^0-9.-]/g, "")) || 0;

  // ‚úÖ Helper: Get target value per FS name (read directly from targets.fs)
function getFSTarget(fsName) {
  const targets = JSON.parse(localStorage.getItem("targets") || "{}");
  const fs = targets.fs || {};

  const normalize = n =>
    String(n || "")
      .toUpperCase()
      .replace(/\s+/g, " ")
      .replace(/\u00A0/g, " ")
      .trim();

  const cleanFS = normalize(fsName);
  const matchKey = Object.keys(fs).find(k => normalize(k) === cleanFS);

  if (!matchKey) {
    console.warn(`‚ö†Ô∏è No target found for FS: ${fsName}`);
    return 0;
  }

  console.log(`üéØ FS Target match: ${matchKey} = ${fs[matchKey]}`);
  return Number(fs[matchKey]) || 0;
}

  // -----------------------------------------------------------
  // ‚ò∞ MENU
  // -----------------------------------------------------------
  const menuIcon = document.querySelector(".menu-icon");
  const dropdownMenu = document.getElementById("dropdownMenu");
  menuIcon.addEventListener("click", () => dropdownMenu.style.display = dropdownMenu.style.display === "block" ? "none" : "block");
  window.addEventListener("click", e => { if (!e.target.closest(".menu-container")) dropdownMenu.style.display = "none"; });

  document.getElementById("logoutLink").addEventListener("click", e => {
    e.preventDefault();
    window.location.href = "https://chadd-cod07.github.io/km6-login/";
  });

  // -----------------------------------------------------------
  // üìÖ DATE INFO
  // -----------------------------------------------------------
  (function updateKPIs(){
    const now = new Date();
    document.querySelector(".summary .date").textContent = now.toLocaleDateString(undefined, { weekday:"short", month:"short", day:"numeric", year:"numeric" });
    const sellingDays = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();
    const actual = now.getDate();
    document.getElementById("sellingDays").textContent = sellingDays;
    document.getElementById("actualDays").textContent = actual;
    document.getElementById("progressPct").textContent = Math.round(actual/sellingDays*100) + "%";
    document.getElementById("remainingDays").textContent = sellingDays - actual;
  })();

  // -----------------------------------------------------------
  // WAIT + COMPUTE DASHBOARD
  // -----------------------------------------------------------
  async function waitForUploads() {
    return new Promise(resolve => {
      const check = () => {
        if (localStorage.getItem("dataweb") && localStorage.getItem("pnetinv") && localStorage.getItem("invoicedate")) resolve(true);
        else setTimeout(check, 1000);
      };
      check();
    });
  }

  async function computeKM6Dashboard() {
    await waitForUploads();

    // ‚úÖ Normalize header data
    function fixData(raw) {
      if (!raw) return [];
      if (Array.isArray(raw) && Array.isArray(raw[0])) {
        const headers = raw[0].map(h => String(h || "").trim());
        return raw.slice(1).map(r => Object.fromEntries(headers.map((h, i) => [h, r[i]])));
      }
      return raw;
    }

    // Load from localStorage
    let dataweb = fixData(JSON.parse(localStorage.getItem("dataweb") || "[]"));
    let pnetinv = fixData(JSON.parse(localStorage.getItem("pnetinv") || "[]"));
    let invoicedate = fixData(JSON.parse(localStorage.getItem("invoicedate") || "[]"));
    const targets = JSON.parse(localStorage.getItem("targets") || "{}");

    if (!dataweb.length && !pnetinv.length) {
      console.warn("‚ö†Ô∏è No uploaded Excel data found.");
      return;
    }

    // -----------------------------------------------------------
// üß© MULTI-BRANCH COMPUTATION (Fixed and Accurate)
// -----------------------------------------------------------
const branches = ["KM6", "KML", "BAGUIO", "KCM"];
const totals = {};

// ‚úÖ Safe numeric parser (no scaling or false multipliers)
const num = v => {
  if (v == null || v === "") return 0;
  const cleaned = String(v).replace(/[‚Ç±,()\s]/g, "").replace(/[^\d.-]/g, "").trim();
  const val = parseFloat(cleaned);
  return isNaN(val) ? 0 : val;
};

branches.forEach(branch => {
  // --- GROSS ---
  const gross = dataweb
    .filter(r => (r["Branch Name"] || "").toUpperCase() === branch)
    .reduce((sum, r) => sum + num(r["Sum of Order Amount"]), 0);

  // --- NET SALES ---
  const net = pnetinv
    .filter(r => (r["Branch Name"] || "").toUpperCase() === branch)
    .reduce((sum, r) => sum + num(r["TOTAL NET"]), 0);

  // --- REJECTION ---
  const rej = pnetinv
    .filter(r => (r["Branch Name"] || "").toUpperCase() === branch)
    .reduce((sum, r) => sum + num(r["TOTAL REJECTION"]), 0);

  // --- B.O AMOUNT ---
  const bo = pnetinv
    .filter(r => (r["Branch Name"] || "").toUpperCase() === branch)
    .reduce((sum, r) => sum + num(r["TOTAL BO"] || r["TOTAL B.O."]), 0);

  // --- SAVE RESULTS ---
  totals[branch] = { gross, net, reject: rej, bo, target: 0 };
});

console.log("‚úÖ Multi-branch totals computed:", totals);

    // -----------------------------------------------------------
    // üéØ TARGET INTEGRATION
    // -----------------------------------------------------------
    if (targets && typeof targets === "object") {
      branches.forEach(branch => {
        const branchTarget = targets[branch] || targets[branch.toLowerCase()] || 0;
        totals[branch].target = num(branchTarget);
      });
    }

    // -----------------------------------------------------------
    // üßÆ DISPLAY & PERCENTAGE CALCULATION
    // -----------------------------------------------------------
    const set = (id, val) => { const el = document.getElementById(id); if (el) el.textContent = fmt(val); };

    let totalAll = { gross: 0, net: 0, reject: 0, bo: 0, target: 0 };
    branches.forEach(branch => {
      const t = totals[branch];
      totalAll.gross += t.gross; totalAll.net += t.net; totalAll.reject += t.reject; totalAll.bo += t.bo; totalAll.target += t.target;
      set(`${branch}_gross`, t.gross);
      set(`${branch}_net`, t.net);
      set(`${branch}_reject`, t.reject);
      set(`${branch}_bo`, t.bo);
      set(`${branch}_target`, t.target);
      const pct = t.target ? ((t.net / t.target) * 100).toFixed(2) + "%" : "-";
      const elPct = document.getElementById(`${branch}_pct`);
      if (elPct) elPct.textContent = pct;
    });

    set("totGross", totalAll.gross);
    set("totNet", totalAll.net);
    set("totReject", totalAll.reject);
    set("totBO", totalAll.bo);
    set("totTarget", totalAll.target);
    document.getElementById("totPct").textContent = totalAll.target ? ((totalAll.net / totalAll.target) * 100).toFixed(2) + "%" : "-";

    // -----------------------------------------------------------
    // üïí INVOICE DATE COMPARISON
    // -----------------------------------------------------------
    if (invoicedate.length > 1) {
      const last = invoicedate[invoicedate.length - 1];
      const prev = invoicedate[invoicedate.length - 2];
      const km6Curr = num(last["KM6"]) + num(last["KML"]);
      const km6Prev = num(prev["KM6"]) + num(prev["KML"]);
      const pct = km6Prev ? ((km6Curr - km6Prev) / km6Prev) * 100 : 0;

      const change = (idPrev, idCurr, idChange, prevVal, currVal) => {
        const elP = document.getElementById(idPrev), elC = document.getElementById(idCurr), elCh = document.getElementById(idChange);
        if (elP) elP.textContent = fmt(prevVal);
        if (elC) elC.textContent = fmt(currVal);
        if (elCh) { elCh.textContent = (pct >= 0 ? "‚ñ≤ " : "‚ñº ") + Math.abs(pct).toFixed(2) + "%"; elCh.className = pct >= 0 ? "up" : "down"; }
      };
      change("prevKM6", "currKM6", "changeKM6", km6Prev, km6Curr);
    }
// -----------------------------------------------------------
// üîÑ FIREBASE SYNC (Upload + Include All Data)
// -----------------------------------------------------------
await db.collection("km6_dashboard_data").doc("dashboardTotals").set({
  totals,
  overall: totalAll,
  dataweb,
  pnetinv,
  invoicedate,
  fsTotals: JSON.parse(localStorage.getItem("fsTotals") || "{}"),
  targets: JSON.parse(localStorage.getItem("targets") || "{}"),
  updated: new Date().toLocaleString(),
});
console.log("‚úÖ Dashboard data saved to Firestore!");

document.getElementById("lastUpdated").textContent =
  "Last updated: " + new Date().toLocaleString();
// ‚úÖ AUTO RESTORE (for Mobile / Empty Local Data)
if (
  !localStorage.getItem("dataweb") ||
  !localStorage.getItem("pnetinv") ||
  !localStorage.getItem("invoicedate") ||
  !localStorage.getItem("fsTotals")
) {
  console.log("üì° Local data missing ‚Äî restoring from Firestore...");
  const snapshot = await db.collection("km6_dashboard_data").doc("dashboardTotals").get();

  if (snapshot.exists) {
    const data = snapshot.data();

    // üßæ Restore all key datasets
    if (data.dataweb) localStorage.setItem("dataweb", JSON.stringify(data.dataweb));
    if (data.pnetinv) localStorage.setItem("pnetinv", JSON.stringify(data.pnetinv));
    if (data.invoicedate) localStorage.setItem("invoicedate", JSON.stringify(data.invoicedate));
    if (data.fsTotals) localStorage.setItem("fsTotals", JSON.stringify(data.fsTotals));
    if (data.overall) localStorage.setItem("overall", JSON.stringify(data.overall));

    console.log("‚úÖ Data fully restored from Firestore.");

    // üßÆ Auto-refresh all major dashboard parts
    computeBranchSummary();
    renderFSTables();
    renderDailySales();
    autoSumTotals();
    updateBranchTargets();
    updateBranchSummaryCalculations();

    // ‚úÖ Update "Last Updated"
    document.getElementById("lastUpdated").textContent =
      "Last updated: " + (data.updated || new Date().toLocaleString());
  } else {
    console.warn("‚ö†Ô∏è No dashboardTotals document found in Firestore.");
  }
} else {
  console.log("‚úÖ LocalStorage data found ‚Äî skipping restore.");
}

// ‚úÖ Timestamp
document.getElementById("lastUpdated").textContent =
  "Last updated: " + new Date().toLocaleString();


    renderFSTables();
  }
  
   // ‚úÖ closes computeKM6Dashboard function properly

// -----------------------------------------------------------
// üßÆ COMPUTE FS TOTALS (Final Stable SUM Version)
// -----------------------------------------------------------
function computeFSTotals() {
  const dataweb = JSON.parse(localStorage.getItem("dataweb") || "[]");
  const pnetinv = JSON.parse(localStorage.getItem("pnetinv") || "[]");

  if (!Array.isArray(dataweb) || !Array.isArray(pnetinv)) {
    console.warn("‚ö†Ô∏è Missing dataweb or pnetinv in localStorage.");
    return;
  }

  const fsTotals = {};

  // ‚úÖ Safe number parser
const num = v => {
  if (v == null || v === "") return 0;
  let cleaned = String(v).replace(/[‚Ç±,()\s]/g, "").replace(/[^\d.-]/g, "").trim();
  let val = parseFloat(cleaned);
  return isNaN(val) ? 0 : val;
};

  // ‚úÖ Normalize FS names
  const cleanFS = s =>
    String(s || "")
      .toUpperCase()
      .replace(/\s+/g, " ")
      .replace(/\u00A0/g, " ")
      .trim();

  // --- STEP 1: GROSS per FS (from dataweb)
  dataweb.forEach(row => {
    const fs = cleanFS(row["FS"]);
    const gross = num(row["Sum of Order Amount"]);
    if (!fs) return;
    if (!fsTotals[fs]) fsTotals[fs] = { gross: 0, reject: 0, bo: 0, net: 0 };
    fsTotals[fs].gross += gross;
  });

  // --- STEP 2: SUM Rejection, BO, NET per FS (from P_Net.Inv)
  pnetinv.forEach(row => {
    const fs = cleanFS(row["FS"]);
    if (!fs) return;
    const rej = num(row["TOTAL REJECTION"]);
    const bo = num(row["TOTAL BO"] || row["TOTAL B.O."]);
    const net = num(row["TOTAL NET"]);

    if (!fsTotals[fs]) fsTotals[fs] = { gross: 0, reject: 0, bo: 0, net: 0 };
    fsTotals[fs].reject += rej;
    fsTotals[fs].bo += bo;
    fsTotals[fs].net += net;
  });

  // --- STEP 3: Save + Log
  localStorage.setItem("fsTotals", JSON.stringify(fsTotals));
  console.log("‚úÖ FS totals computed (final SUM version):", fsTotals);
}

// üü© Compute FS totals only if missing or outdated
let existingFsTotals = JSON.parse(localStorage.getItem("fsTotals") || "{}");
if (!Object.keys(existingFsTotals).length) {
  console.log("üßÆ Recomputing FS totals (none found in storage)...");
  computeFSTotals();
} else {
  console.log("üì¶ Loaded FS totals from localStorage:", existingFsTotals);
}

// ‚úÖ Ensure FS totals exist before rendering tables
let fsData = JSON.parse(localStorage.getItem("fsTotals") || "{}");
if (!Object.keys(fsData).length) {
  console.log("üßÆ Recomputing FS totals before rendering...");
  computeFSTotals(); // rebuild data from sheets
  fsData = JSON.parse(localStorage.getItem("fsTotals") || "{}");
}

// üßπ Clean and correct scaled Target data in localStorage
(() => {
  const fsData = JSON.parse(localStorage.getItem("fsTargetData") || "[]");
  const cleaned = fsData.map(t => {
    const val = parseFloat(String(t.Target).replace(/[^\d.-]/g, ""));
    let fixed = val;

    // Detect 5√ó or 10√ó scaling errors and correct
    if (fixed > 100000000) fixed /= 10; // too large (e.g., 150M ‚Üí 15M)
    if (fixed > 70000000 && fixed < 80000000) fixed /= 5; // special case like Jim Russel
    if (fixed > 10000000 && fixed < 20000000) fixed = fixed; // looks valid

    return { ...t, Target: fixed };
  });

  localStorage.setItem("fsTargetData", JSON.stringify(cleaned));
  console.log("‚úÖ Cleaned fsTargetData saved:", cleaned);
})();

renderFSTables();

// -----------------------------------------------------------
// üßæ RENDER FS TABLES (Smart match + Correct Targets + Clean Format)
// -----------------------------------------------------------
function renderFSTables() {
  const fsTotals = JSON.parse(localStorage.getItem("fsTotals") || "{}");

  const groups = {
    KCM: ["Jim Russel Peralta", "Judy Ann Mabanta", "Gilbert Aquino", "Roderick Dacay", "Gyver Gano"],
    LU: ["Gemma Jacaban", "Jovelyn Castro"],
    BG: ["Jehu Romero", "Mc Ardel Cachicho", "Rocky Fowaya"]
  };

  const tableIds = { KCM: "tblKCM", LU: "tblLU", BG: "tblBG" };

  // ‚úÖ Safe numeric parser
  const num = v => {
    if (v == null || v === "") return 0;
    const cleaned = String(v).replace(/[‚Ç±,()\s]/g, "").replace(/[^\d.-]/g, "").trim();
    const val = parseFloat(cleaned);
    return isNaN(val) ? 0 : val;
  };

  const fmt = n => Number(n || 0).toLocaleString(undefined, {
    minimumFractionDigits: 2,
    maximumFractionDigits: 2
  });

  // ‚úÖ Normalize FS names
  const cleanName = n =>
    String(n || "")
      .toUpperCase()
      .replace(/\s+/g, " ")
      .replace(/\u00A0/g, " ")
      .trim();

  // ‚úÖ Load targets
  const storedTargets = JSON.parse(localStorage.getItem("targets") || "{}");
  const fsTargets = storedTargets.fs || {};

  console.log("‚úÖ Loaded FS targets:", fsTargets);

  // üîπ Loop through each group (KCM, LU, BG)
  for (const [group, names] of Object.entries(groups)) {
    const tbody = document.querySelector(`#${tableIds[group]}`);
    if (!tbody) continue;

    const totalRow = tbody.querySelector(".total");
    tbody.innerHTML = "";
    if (totalRow) tbody.appendChild(totalRow);

    let total = { gross: 0, reject: 0, bo: 0, net: 0, target: 0, balance: 0 };

    // üîπ Render each FS under this group
    names.forEach(name => {
      const fsKey = cleanName(name);
      let matchedKey = Object.keys(fsTotals).find(k => cleanName(k) === fsKey) || null;
      const d = matchedKey ? fsTotals[matchedKey] : {};

      const g = num(d.gross);
      const r = num(d.reject);
      const b = num(d.bo);
      const n = num(d.net);

      // ‚úÖ Target value
      const target = fsTargets[fsKey] || fsTargets[fsKey.toUpperCase()] || 0;
      const pct = target > 0 ? (n / target) * 100 : 0;
      const balance = n - target;

      console.log(`${name} | Net: ${n} | Target: ${target} | %: ${pct.toFixed(2)}`);

      total.gross += g;
      total.reject += r;
      total.bo += b;
      total.net += n;
      total.target += target;
      total.balance += balance;

      // ‚úÖ Format with parentheses for negatives
      const fmtVal = (v, isPct = false) => {
        if (isPct)
          return v.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        const abs = Math.abs(v).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        return v < 0 ? `(${abs})` : abs;
      };

      // ‚úÖ No more color-coded %
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${name}</td>
        <td>${fmtVal(g)}</td>
        <td>${fmtVal(r)}</td>
        <td>${fmtVal(b)}</td>
        <td>${fmtVal(n)}</td>
        <td>${fmtVal(target)}</td>
        <td>${fmtVal(pct, true)}%</td>
        <td>${fmtVal(balance)}</td>
      `;
      tbody.insertBefore(tr, totalRow);
    });

    // ‚úÖ Update total row
    const totalPct = total.target > 0 ? (total.net / total.target) * 100 : 0;
    const fmtBalance = total.balance < 0
      ? `(${Math.abs(total.balance).toLocaleString(undefined, { minimumFractionDigits: 2 })})`
      : total.balance.toLocaleString(undefined, { minimumFractionDigits: 2 });

    totalRow.innerHTML = `
      <td><b>Total ${group}</b></td>
      <td><b>${fmt(total.gross)}</b></td>
      <td><b>${fmt(total.reject)}</b></td>
      <td><b>${fmt(total.bo)}</b></td>
      <td><b>${fmt(total.net)}</b></td>
      <td><b>${fmt(total.target)}</b></td>
      <td><b>${fmt(totalPct)}%</b></td>
      <td><b>${fmtBalance}</b></td>
    `;
    totalRow.style.backgroundColor = "#fff8cc";
  }
}

// -----------------------------------------------------------
// üßÆ COMPUTE BRANCH SUMMARY (Baguio + La Union)
// -----------------------------------------------------------
function computeBranchSummary() {
  const fsTotals = JSON.parse(localStorage.getItem("fsTotals") || "{}");
  const dataweb = JSON.parse(localStorage.getItem("dataweb") || "[]");
  const pnetinv = JSON.parse(localStorage.getItem("pnetinv") || "[]");

  const branches = {
    BAGUIO: { gross: 0, reject: 0, bo: 0, net: 0 },
    "LA UNION": { gross: 0, reject: 0, bo: 0, net: 0 }
  };

  const num = t => parseFloat(String(t || "").replace(/[^0-9.-]/g, "")) || 0;

  // --- From GROSS sheet (dataweb) ---
  dataweb.forEach(r => {
    const rec = {};
    for (const [k, v] of Object.entries(r)) rec[k.trim().toUpperCase()] = v;

    const branch = (rec["BRANCH NAME"] || "").toUpperCase();
    const gross = num(rec["SUM OF ORDER AMOUNT"]);

    if (branch.includes("KM6") || branch.includes("BAGUIO")) branches.BAGUIO.gross += gross;
    if (branch.includes("KML") || branch.includes("LA UNION")) branches["LA UNION"].gross += gross;
  });

  // --- From P_Net.Inv sheet (pnetinv) ---
  pnetinv.forEach(r => {
    const rec = {};
    for (const [k, v] of Object.entries(r)) rec[k.trim().toUpperCase()] = v;

    const branch = (rec["BRANCH NAME"] || "").toUpperCase();
    const rej = num(rec["TOTAL REJECTION"]);
    const bo = num(rec["TOTAL BO"]) || num(rec["TOTAL B.O."]);
    const net = num(rec["TOTAL NET"]);

    if (branch.includes("KM6") || branch.includes("BAGUIO")) {
      branches.BAGUIO.reject += rej;
      branches.BAGUIO.bo += bo;
      branches.BAGUIO.net += net;
    }
    if (branch.includes("KML") || branch.includes("LA UNION")) {
      branches["LA UNION"].reject += rej;
      branches["LA UNION"].bo += bo;
      branches["LA UNION"].net += net;
    }
  });

  // --- Helper for formatting ---
  const fmt = n => Number(n || 0).toLocaleString(undefined, {
    minimumFractionDigits: 2,
    maximumFractionDigits: 2
  });
  const set = (id, val) => {
    const el = document.getElementById(id);
    if (el) el.textContent = fmt(val);
  };

  // --- Display individual branches ---
  set("km6Gross", branches.BAGUIO.gross);
  set("km6Reject", branches.BAGUIO.reject);
  set("km6BO", branches.BAGUIO.bo);
  set("km6Net", branches.BAGUIO.net);

  set("kmlGross", branches["LA UNION"].gross);
  set("kmlReject", branches["LA UNION"].reject);
  set("kmlBO", branches["LA UNION"].bo);
  set("kmlNet", branches["LA UNION"].net);

  // --- ‚úÖ FIXED: Compute total row ---
  const totalGross = branches.BAGUIO.gross + branches["LA UNION"].gross;
  const totalReject = branches.BAGUIO.reject + branches["LA UNION"].reject;
  const totalBO = branches.BAGUIO.bo + branches["LA UNION"].bo;
  const totalNet = branches.BAGUIO.net + branches["LA UNION"].net;

  // --- Update total KM6 row ---
  set("totGross", totalGross);
  set("totReject", totalReject);
  set("totBO", totalBO);
  set("totNet", totalNet);

  console.log("üè¢ Branch summary (Baguio + La Union):", branches);
  console.log("üìä Total KM6:", { totalGross, totalReject, totalBO, totalNet });
}


// -----------------------------------------------------------
// üßÆ COMPUTE BRANCH SUMMARY (Baguio + La Union)
// -----------------------------------------------------------
function computeBranchSummary() {
  const fsTotals = JSON.parse(localStorage.getItem("fsTotals") || "{}");
  const dataweb = JSON.parse(localStorage.getItem("dataweb") || "[]");
  const pnetinv = JSON.parse(localStorage.getItem("pnetinv") || "[]");

  const branches = {
    BAGUIO: { gross: 0, reject: 0, bo: 0, net: 0 },
    "LA UNION": { gross: 0, reject: 0, bo: 0, net: 0 }
  };

  const num = t => parseFloat(String(t || "").replace(/[^0-9.-]/g, "")) || 0;

  // --- From GROSS sheet (dataweb) ---
  dataweb.forEach(r => {
    const rec = {};
    for (const [k, v] of Object.entries(r)) rec[k.trim().toUpperCase()] = v;

    const branch = (rec["BRANCH NAME"] || "").toUpperCase();
    const gross = num(rec["SUM OF ORDER AMOUNT"]);

    if (branch.includes("KM6") || branch.includes("BAGUIO")) branches.BAGUIO.gross += gross;
    if (branch.includes("KML") || branch.includes("LA UNION")) branches["LA UNION"].gross += gross;
  });

  // --- From P_Net.Inv sheet (pnetinv) ---
  pnetinv.forEach(r => {
    const rec = {};
    for (const [k, v] of Object.entries(r)) rec[k.trim().toUpperCase()] = v;

    const branch = (rec["BRANCH NAME"] || "").toUpperCase();
    const rej = num(rec["TOTAL REJECTION"]);
    const bo = num(rec["TOTAL BO"]) || num(rec["TOTAL B.O."]);
    const net = num(rec["TOTAL NET"]);

    if (branch.includes("KM6") || branch.includes("BAGUIO")) {
      branches.BAGUIO.reject += rej;
      branches.BAGUIO.bo += bo;
      branches.BAGUIO.net += net;
    }
    if (branch.includes("KML") || branch.includes("LA UNION")) {
      branches["LA UNION"].reject += rej;
      branches["LA UNION"].bo += bo;
      branches["LA UNION"].net += net;
    }
  });

  // --- Helper for formatting ---
  const fmt = n => Number(n || 0).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
  const set = (id, val) => {
    const el = document.getElementById(id);
    if (el) el.textContent = fmt(val);
  };

  // --- Display individual branches ---
  set("km6Gross", branches.BAGUIO.gross);
  set("km6Reject", branches.BAGUIO.reject);
  set("km6BO", branches.BAGUIO.bo);
  set("km6Net", branches.BAGUIO.net);

  set("kmlGross", branches["LA UNION"].gross);
  set("kmlReject", branches["LA UNION"].reject);
  set("kmlBO", branches["LA UNION"].bo);
  set("kmlNet", branches["LA UNION"].net);

  // --- ‚úÖ FIXED: Compute total row ---
  const totalGross = branches.BAGUIO.gross + branches["LA UNION"].gross;
  const totalReject = branches.BAGUIO.reject + branches["LA UNION"].reject;
  const totalBO = branches.BAGUIO.bo + branches["LA UNION"].bo;
  const totalNet = branches.BAGUIO.net + branches["LA UNION"].net;

  // --- Update total KM6 row ---
  set("totGross", totalGross);
  set("totReject", totalReject);
  set("totBO", totalBO);
  set("totNet", totalNet);

  console.log("üè¢ Branch summary (Baguio + La Union):", branches);
  console.log("üìä Total KM6:", { totalGross, totalReject, totalBO, totalNet });
}

// -----------------------------------------------------------
// INITIAL LOAD + AUTO REFRESH (Final Clean Version)
// -----------------------------------------------------------
computeKM6Dashboard();
computeBranchSummary(); // ‚úÖ Make sure Branch Summary runs immediately
autoSumTotals(); // ‚úÖ Run Excel-like AutoSum once when page loads

window.addEventListener("storage", e => {
  if (["dataweb", "pnetinv", "invoicedate", "fsTotals"].includes(e.key)) {
    computeKM6Dashboard();
    computeBranchSummary();
    autoSumTotals(); // ‚úÖ Recalculate totals whenever data updates
  }
});

// -----------------------------------------------------------
// ‚úÖ AUTO-SUM LOGIC (like Excel)
// -----------------------------------------------------------
function autoSumTotals() {
  function getNumber(id) {
    const el = document.getElementById(id);
    return el ? parseFloat(el.textContent.replace(/,/g, "")) || 0 : 0;
  }

  function setNumber(id, value) {
    const el = document.getElementById(id);
    if (el)
      el.textContent = value.toLocaleString(undefined, {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2,
      });
  }

  // --- Excel-style "AutoSum" for Total KM6 ---
  const totalGross = getNumber("km6Gross") + getNumber("kmlGross");
  const totalReject = getNumber("km6Reject") + getNumber("kmlReject");
  const totalBO = getNumber("km6BO") + getNumber("kmlBO");
  const totalNet = getNumber("km6Net") + getNumber("kmlNet");

  // --- Update Total KM6 row ---
  setNumber("totGross", totalGross);
  setNumber("totReject", totalReject);
  setNumber("totBO", totalBO);
  setNumber("totNet", totalNet);

  console.log("üìä AutoSum Total KM6:", {
    totalGross,
    totalReject,
    totalBO,
    totalNet,
  });
}
</script>
<script>
// -----------------------------------------------------------
// ‚úÖ AUTO-SUM LOGIC (Works on visible table rows)
// -----------------------------------------------------------
function autoSumTotals() {
  const table = document.querySelector(".table-container table");
  if (!table) return;

  // get all rows inside tbody
  const rows = table.querySelectorAll("tbody tr");
  let totalGross = 0, totalReject = 0, totalBO = 0, totalNet = 0;

  rows.forEach(row => {
    const cells = row.querySelectorAll("td");
    if (!cells.length) return;
    const branchName = cells[0].innerText.trim();

    // skip the total row
    if (branchName.toLowerCase().includes("total km6")) return;

    totalGross += Number(cells[1].innerText.replace(/,/g, "")) || 0;
    totalReject += Number(cells[2].innerText.replace(/,/g, "")) || 0;
    totalBO += Number(cells[3].innerText.replace(/,/g, "")) || 0;
    totalNet += Number(cells[4].innerText.replace(/,/g, "")) || 0;
  });

  // find the "Total KM6" row
  const totalRow = Array.from(rows).find(row =>
    row.querySelector("td")?.innerText.trim().toLowerCase().includes("total km6")
  );

  if (totalRow) {
    const tds = totalRow.querySelectorAll("td");
    tds[1].innerText = totalGross.toLocaleString(undefined, { minimumFractionDigits: 2 });
    tds[2].innerText = totalReject.toLocaleString(undefined, { minimumFractionDigits: 2 });
    tds[3].innerText = totalBO.toLocaleString(undefined, { minimumFractionDigits: 2 });
    tds[4].innerText = totalNet.toLocaleString(undefined, { minimumFractionDigits: 2 });
  }

  console.log("üìä AutoSum Total KM6:", {
    totalGross,
    totalReject,
    totalBO,
    totalNet,
  });
}

// Run after table render (slight delay ensures data loaded)
setTimeout(autoSumTotals, 800);
</script>
<script>
// ‚úÖ Helper: Get target value per FS name
function getFSTarget(fsName) {
  const data = JSON.parse(localStorage.getItem("fsTargetData") || "[]");
  const normalize = n => String(n || "").toUpperCase().replace(/\s+/g, " ").trim();
  const match = fsData.find(x => normalize(x.FS || x.Branch || x.Name) === normalize(fsName));
  console.log("üîç Matching FS target:", fsName, "‚Üí", match ? match.Target : "‚ùå not found");

  return match ? Number(match.Target) : 0;
}

// ‚úÖ Auto-fill Target column in all FS tables (KCM, LU, Baguio)
// ‚úÖ Helper: Get target value per FS name (uses the new 'targets.fs' data)
function getFSTarget(fsName) {
  const targets = JSON.parse(localStorage.getItem("targets") || "{}");
  const fs = targets.fs || {}; // ‚úÖ correct source

  // Normalize to avoid spacing / case issues
  const normalize = n =>
    String(n || "")
      .toUpperCase()
      .replace(/\s+/g, " ")
      .replace(/\u00A0/g, " ")
      .trim();

  const cleanFS = normalize(fsName);
  const keys = Object.keys(fs);

  // Find matching FS name (exact or close)
  const matchKey =
    keys.find(k => normalize(k) === cleanFS) ||
    keys.find(k => normalize(k).includes(cleanFS)) ||
    keys.find(k => cleanFS.includes(normalize(k)));

  if (!matchKey) {
    console.warn(`‚ö†Ô∏è FS target not found for: ${fsName}`);
    return 0;
  }

  const targetVal = Number(fs[matchKey]) || 0;
  console.log(`üéØ Matched FS Target: ${matchKey} = ${targetVal.toLocaleString()}`);
  return targetVal;
}

// ‚úÖ Run after page loads
window.addEventListener("DOMContentLoaded", () => {
  setTimeout(updateFSTargets, 1000);
});
</script>
<script>
// ‚úÖ Auto-sum "Target" column totals in each FS table
function autoSumFSTargetTotals() {
  const tables = ["tblKCM", "tblLU", "tblBG"]; // table IDs
  tables.forEach(tblId => {
    const tbody = document.getElementById(tblId);
    if (!tbody) return;

    const rows = tbody.querySelectorAll("tr:not(.total)");
    const totalRow = tbody.querySelector("tr.total");
    if (!totalRow) return;

    let totalTarget = 0;

    rows.forEach(row => {
      const cells = row.querySelectorAll("td");
      if (cells.length < 6) return;
      const val = Number(cells[5].innerText.replace(/,/g, "")) || 0;
      totalTarget += val;
    });

    // update the total target cell (6th <td>)
    const totalCells = totalRow.querySelectorAll("td");
    if (totalCells.length >= 6) {
      totalCells[5].innerText = totalTarget.toLocaleString(undefined, { minimumFractionDigits: 2 });
    }
  });

  console.log("üßÆ Auto-summed total Targets per FS table.");
}

// ‚úÖ Run after target values are filled
window.addEventListener("DOMContentLoaded", () => {
  setTimeout(() => {
    updateFSTargets();
    autoSumFSTargetTotals();
  }, 1200);
});
</script>
<script>
// ‚úÖ Map branch names (for clarity)
const branchMap = {
  "Baguio": "KM6",
  "La Union": "KML"
};
// ‚úÖ Fix: Define the missing updateFSTargets function (new structure)
function updateFSTargets() {
  const targets = JSON.parse(localStorage.getItem("targets") || "{}");
  const fs = targets.fs || {};

  if (!Object.keys(fs).length) {
    console.warn("‚ö†Ô∏è No FS target data found in localStorage.targets.fs");
    return;
  }

  console.log("‚úÖ Loaded FS targets:", fs);

  // Loop through FS rows in dashboard (where the target column should be updated)
  document.querySelectorAll("table tbody tr").forEach(row => {
    const fsName = row.cells[0]?.textContent?.trim();
    const targetCell = row.cells[5]; // assuming TARGET is column 6

    if (!fsName || !targetCell) return;

    const normalize = n =>
      String(n || "")
        .toUpperCase()
        .replace(/\s+/g, " ")
        .replace(/\u00A0/g, " ")
        .trim();

    const matchKey = Object.keys(fs).find(k => normalize(k) === normalize(fsName));

    if (matchKey) {
      const targetVal = Number(fs[matchKey]) || 0;
      targetCell.textContent = targetVal.toLocaleString(undefined, {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2,
      });
    } else {
      targetCell.textContent = "0.00";
    }
  });

  console.log("üéØ FS Targets updated successfully from localStorage.targets.fs");
}

// ‚úÖ Auto-fill Branch Summary Targets directly from uploaded data (KM6 ‚Üí Baguio, KML ‚Üí La Union)
function updateBranchTargets() {
  const targetData = JSON.parse(localStorage.getItem("targets") || "{}");
  if (!targetData.branches) {
    console.warn("‚ö†Ô∏è No branch-level target data found.");
    return;
  }

  // --- Auto-map Excel branch names to dashboard display names ---
  const km6Val = targetData.branches.KM6 || targetData.branches.BAGUIO || 0;
  const kmlVal = targetData.branches.KML || targetData.branches["LA UNION"] || 0;

  // --- Update table cells ---
  const bagCell = document.getElementById("km6Target"); // Baguio
  const luCell  = document.getElementById("kmlTarget"); // La Union
  const totalCell = document.getElementById("totTarget");

  if (bagCell) bagCell.innerText = km6Val.toLocaleString(undefined, { minimumFractionDigits: 2 });
  if (luCell)  luCell.innerText  = kmlVal.toLocaleString(undefined, { minimumFractionDigits: 2 });
  if (totalCell) totalCell.innerText = (km6Val + kmlVal).toLocaleString(undefined, { minimumFractionDigits: 2 });

  console.log("üè¢ Branch Targets updated automatically from Excel:", {
    Baguio: km6Val,
    "La Union": kmlVal,
    Total: km6Val + kmlVal
  });
}

// ‚úÖ Run after everything else is done
window.addEventListener("DOMContentLoaded", () => {
  setTimeout(updateBranchTargets, 1500);
});
</script>
<script>
// ‚úÖ Compute % and Balance for each branch (with accounting-style negatives)
function updateBranchSummaryCalculations() {
  const rows = [
    { netId: "km6Net", targetId: "km6Target", pctId: "km6Pct", balId: "km6Bal" },
    { netId: "kmlNet", targetId: "kmlTarget", pctId: "kmlPct", balId: "kmlBal" }
  ];

  let totalNet = 0, totalTarget = 0, totalBal = 0;

  rows.forEach(row => {
    const net = parseFloat((document.getElementById(row.netId)?.innerText || "0").replace(/,/g, "")) || 0;
    const tar = parseFloat((document.getElementById(row.targetId)?.innerText || "0").replace(/,/g, "")) || 0;

    let pct = 0;
    let bal = net - tar;

    if (tar > 0) pct = (net / tar) * 100;

    // ‚úÖ Format percentage
    const pctText = pct.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + "%";

    // ‚úÖ Format balance (if negative ‚Üí show in parentheses)
    const balText = bal < 0
      ? `(${Math.abs(bal).toLocaleString(undefined, { minimumFractionDigits: 2 })})`
      : bal.toLocaleString(undefined, { minimumFractionDigits: 2 });

    document.getElementById(row.pctId).innerText = pctText;
    document.getElementById(row.balId).innerText = balText;

    totalNet += net;
    totalTarget += tar;
    totalBal += bal;
  });

  // ‚úÖ Compute totals for ‚ÄúTotal KM6‚Äù row
  const totPct = totalTarget > 0 ? (totalNet / totalTarget) * 100 : 0;
  const totBalText = totalBal < 0
    ? `(${Math.abs(totalBal).toLocaleString(undefined, { minimumFractionDigits: 2 })})`
    : totalBal.toLocaleString(undefined, { minimumFractionDigits: 2 });

  document.getElementById("totPct").innerText = totPct.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + "%";
  document.getElementById("totBal").innerText = totBalText;

  console.log("üìä Branch Summary % and Balance updated successfully.");
}

// ‚úÖ Run automatically after branch targets update
window.addEventListener("DOMContentLoaded", () => {
  setTimeout(() => {
    updateBranchTargets();
    updateBranchSummaryCalculations();
  }, 2000);
});

/// üßæ DAILY SALES COMPUTATION + DISPLAY (From "Invoice date" sheet)
// -----------------------------------------------------------
function computeDailySales(invoiceData) {
  if (!invoiceData || !invoiceData.length) return null;

  // ‚úÖ Normalize headers (convert to uppercase for consistent access)
  invoiceData = invoiceData.map(r => {
    const obj = {};
    for (const [k, v] of Object.entries(r)) obj[k.trim().toUpperCase()] = v;
    return obj;
  });

  // ‚úÖ Filter only rows that have valid KM6, KML, or TOTAL data
  const validRows = invoiceData.filter(r =>
    r["INVOICE DATE"] && (r["KM6"] || r["KML"] || r["TOTAL"])
  );

  if (!validRows.length) {
    console.warn("‚ö†Ô∏è No valid 'Invoice date' rows found.");
    return null;
  }

  console.log("üìò Loaded Invoice date data:", validRows.slice(-5));

  if (validRows.length < 2) return null; // not enough data for comparison

  // ‚úÖ Get previous and current day records (last two rows)
  const prev = validRows[validRows.length - 2];
  const curr = validRows[validRows.length - 1];

  const toNum = v => parseFloat(String(v || "0").replace(/[^0-9.-]/g, "")) || 0;
  const calcChange = (currVal, prevVal) =>
    prevVal !== 0 ? ((currVal - prevVal) / prevVal) * 100 : 0;

  return {
    KM6: {
      prev: toNum(prev["KM6"]),
      curr: toNum(curr["KM6"]),
      change: calcChange(toNum(curr["KM6"]), toNum(prev["KM6"]))
    },
    KML: {
      prev: toNum(prev["KML"]),
      curr: toNum(curr["KML"]),
      change: calcChange(toNum(curr["KML"]), toNum(prev["KML"]))
    },
    Total: {
      prev: toNum(prev["TOTAL"]),
      curr: toNum(curr["TOTAL"]),
      change: calcChange(toNum(curr["TOTAL"]), toNum(prev["TOTAL"]))
    }
  };
}

function renderDailySales() {
  // ‚úÖ Support all possible key names in localStorage
  const invoiceData =
    JSON.parse(localStorage.getItem("invoicedate") || "[]") ||
    JSON.parse(localStorage.getItem("invoiceDateData") || "[]") ||
    [];

  if (!invoiceData.length) {
    console.warn("‚ö†Ô∏è No 'Invoice date' data found in localStorage.");
    return;
  }

  const dailySales = computeDailySales(invoiceData);
  if (!dailySales) return;

  const peso = n => "‚Ç±" + Number(n).toLocaleString("en-PH", { minimumFractionDigits: 2 });
  const arrow = pct =>
    pct > 0
      ? `<span style='color:green;'>‚ñ≤ ${pct.toFixed(2)}%</span>`
      : pct < 0
      ? `<span style='color:red;'>‚ñº ${Math.abs(pct).toFixed(2)}%</span>`
      : `<span style='color:gray;'>0.00%</span>`;

  // üü© Update Cards
  document.getElementById("prevKM6").textContent = peso(dailySales.Total.prev);
  document.getElementById("currKM6").textContent = peso(dailySales.Total.curr);
  document.getElementById("changeKM6").innerHTML = arrow(dailySales.Total.change);

  // ‚ÄúKM6‚Äù = Baguio
  document.getElementById("prevBaguio").textContent = peso(dailySales.KM6.prev);
  document.getElementById("currBaguio").textContent = peso(dailySales.KM6.curr);
  document.getElementById("changeBaguio").innerHTML = arrow(dailySales.KM6.change);

  // ‚ÄúKML‚Äù = La Union
  document.getElementById("prevLU").textContent = peso(dailySales.KML.prev);
  document.getElementById("currLU").textContent = peso(dailySales.KML.curr);
  document.getElementById("changeLU").innerHTML = arrow(dailySales.KML.change);

  console.log("‚úÖ Daily Sales Updated from 'Invoice date' sheet:", dailySales);
}

// Auto-run once page is loaded
window.addEventListener("DOMContentLoaded", () => {
  setTimeout(renderDailySales, 500);
});


// -----------------------------------------------------------
// üîÑ AUTO-REFRESH DASHBOARD WHEN UPLOAD PAGE UPDATES STORAGE
// -----------------------------------------------------------
window.addEventListener("storage", (event) => {
  const keys = ["dataweb", "pnetinv", "invoicedate", "invoiceDateData", "targets"];
  if (keys.includes(event.key)) {
    console.log("üîÑ Detected data update from upload page. Refreshing dashboard...");
    computeKM6Dashboard();
    computeBranchSummary();
    autoSumTotals();
    updateBranchTargets();
    updateBranchSummaryCalculations();
  }
});
window.addEventListener("storage", (event) => {
  if (event.key === "invoicedate") {
    console.log("üîÑ Detected new Invoice date upload, refreshing daily sales...");
    renderDailySales();
  }
});
</script>
</body>
</html>