<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>KM6 Sales Dashboard</title>
  <link rel="stylesheet" href="style.css" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    /* ===== Dropdown Menu Styling (kept) ===== */
    .menu-container { position: relative; display: inline-block; }
    .menu-icon { cursor: pointer; font-size: 24px; user-select: none; }
    .dropdown-menu {
      display: none; position: absolute; right: 0; background-color: #ffffff;
      min-width: 180px; box-shadow: 0 8px 16px rgba(0,0,0,0.2); border-radius: 8px;
      z-index: 999; overflow: hidden; animation: fadeIn 0.2s ease-in-out;
    }
    .dropdown-menu a {
      display: flex; align-items: center; gap: 8px; color: #333;
      padding: 10px 16px; text-decoration: none; font-size: 15px; transition: background 0.2s;
    }
    .dropdown-menu a:hover { background-color: #f0f0f0; }
    @keyframes fadeIn { from {opacity: 0; transform: translateY(-5px);} to {opacity: 1; transform: translateY(0);} }

    /* ‚úÖ Mobile Responsive Tables */
    .table-container { width: 100%; overflow-x: auto; -webkit-overflow-scrolling: touch; }
    table { width: 100%; border-collapse: collapse; min-width: 600px; }
    th, td { text-align: left; padding: 8px; white-space: nowrap; }
    .negative { color: red; }
    .up { color: #00843d; font-weight: 700; }
    .down { color: #c62828; font-weight: 700; }
    .total td { background: #eef8e9; font-weight: 700; }
    .summary h2 .date { color: #d32f2f; }
  </style>
</head>
<body>
  <header class="header">
    <div class="logo">
      <img src="your-logo.png" alt="KM6 Logo" />
      <h1>GENERAL MERCHANDISE</h1>
    </div>
    <div class="header-right">
      <h2><a href="#" class="nav-link" id="totalSalesLink">Total Sales</a></h2>
      <h2><a href="#" class="nav-link" id="dspSalesLink">DSP-Sales</a></h2>
      <h2><a href="#" class="nav-link" id="focus30Link">Focus 30</a></h2>

      <div class="menu-container">
        <div class="menu-icon">‚ò∞</div>
        <div class="dropdown-menu" id="dropdownMenu">
          <a href="logout.html">üîí Log Out</a>
          <a href="https://chadd-cod07.github.io/km6-login/km6-dashboard/upload.html">‚¨ÜÔ∏è Upload Excel File</a>
          <a href="settings.html">‚öôÔ∏è Settings</a>
        </div>
      </div>
    </div>
  </header>

  <section class="summary">
    <h2>Daily Sales as of <span class="date">Mon Oct 20, 2025</span></h2>
    <div class="info">
      <p><strong>Selling Days:</strong> <span id="sellingDays">0</span></p>
      <p><strong>Actual Days:</strong> <span id="actualDays">0</span></p>
      <p><strong>Progress:</strong> <span id="progressPct">0%</span></p>
      <p><strong>Remaining Days:</strong> <span id="remainingDays">0</span></p>
    </div>
  </section>

  <!-- Daily Sales Current vs Previous (kept; values will remain as-is for now) -->
  <section class="compare-section">
    <h2>Daily Sales Current vs Previous</h2>
    <div class="compare-cards">
      <div class="card total">
        <h3>Total KM6</h3>
        <p><strong>Previous Sales:</strong> 5,972,244.39</p>
        <p><strong>Current Sales:</strong> 2,428,661.17</p>
        <p class="down">‚ñº 42.18%</p>
      </div>
      <div class="card baguio">
        <h3>Total Baguio</h3>
        <p><strong>Previous Sales:</strong> 4,234,112.52</p>
        <p><strong>Current Sales:</strong> 517,089.66</p>
        <p class="down">‚ñº 78.23%</p>
      </div>
      <div class="card launion">
        <h3>Total La Union</h3>
        <p><strong>Previous Sales:</strong> 1,738,131.87</p>
        <p><strong>Current Sales:</strong> 1,911,571.51</p>
        <p class="up">‚ñ≤ 4.75%</p>
      </div>
    </div>
  </section>
<p class="updated-time" id="lastUpdated" style="font-size:.9em;color:#555;margin-top:6px;">
  Last updated: --
</p>

  <!-- Branch Table -->
  <section class="table-section">
    <h2>Branch Summary</h2>
    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>Branch</th>
            <th>Gross</th>
            <th>Rejection</th>
            <th>B.O Amount</th>
            <th>Net Sales</th>
            <th>Target</th>
            <th>%</th>
            <th>Balance</th>
          </tr>
        </thead>
        <tbody>
<tr>
  <td>Baguio</td>
  <td id="km6Gross">-</td>
  <td id="km6Reject">-</td>
  <td id="km6BO">-</td>
  <td id="km6Net">-</td>
  <td>91,127,709.64</td>
  <td>-</td>
  <td>-</td>
</tr>
<tr>
  <td>La Union</td>
  <td id="kmlGross">-</td>
  <td id="kmlReject">-</td>
  <td id="kmlBO">-</td>
  <td id="kmlNet">-</td>
  <td>47,136,762.36</td>
  <td>-</td>
  <td>-</td>
</tr>
          <tr class="total">
            <td><strong>Total KM6</strong></td>
            <td>-</td><td>-</td><td>1,950,073.85</td><td>-</td>
            <td>138,264,472.00</td>
            <td>-</td><td>-</td>
          </tr>
        </tbody>
      </table>
    </div>
  </section>

  <!-- KCM Table -->
  <section class="table-group">
    <h2>Total KCM</h2>
    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>KCM</th>
            <th>Gross</th>
            <th>Rejection</th>
            <th>B.O Amount</th>
            <th>Net Sales</th>
            <th>Target</th>
            <th>%</th>
            <th>Balance</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>Jim Russel Peralta</td>
            <td>-</td><td>-</td><td>-</td><td>-</td>
            <td>15,071,696.63</td><td>-</td><td>-</td>
          </tr>
          <tr>
            <td>Judy Ann Mabanta</td>
            <td>-</td><td>-</td><td>-</td><td>-</td>
            <td>4,367,754.61</td><td>-</td><td>-</td>
          </tr>
          <tr>
            <td>Gilbert Aquino</td>
            <td>-</td><td>-</td><td>-</td><td>-</td>
            <td>37,611,090.41</td><td>-</td><td>-</td>
          </tr>
          <tr>
            <td>Roderick Dacay</td>
            <td>-</td><td>-</td><td>-</td><td>-</td>
            <td>17,302,603.09</td><td>-</td><td>-</td>
          </tr>
          <tr>
            <td>Gyver Gano</td>
            <td>-</td><td>-</td><td>-</td><td>-</td>
            <td>3,760,520.90</td><td>-</td><td>-</td>
          </tr>
          <tr class="total">
            <td><strong>Total KCM</strong></td>
            <td>-</td><td>-</td><td>-</td><td>-</td>
            <td>78,114,214.71</td><td>-</td><td>-</td>
          </tr>
        </tbody>
      </table>
    </div>
  </section>

  <!-- Tertiary La Union -->
  <section class="table-group">
    <h2>Tertiary LU</h2>
    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>Name</th>
            <th>Gross</th>
            <th>Rejection</th>
            <th>B.O Amount</th>
            <th>Net Sales</th>
            <th>Target</th>
            <th>%</th>
            <th>Balance</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>Gemma Jacaban</td>
            <td>-</td><td>-</td><td>-</td><td>-</td>
            <td>4,075,946.99</td><td>-</td><td>-</td>
          </tr>
          <tr>
            <td>Jovelyn Castro</td>
            <td>-</td><td>-</td><td>-</td><td>-</td>
            <td>20,177,154.31</td><td>-</td><td>-</td>
          </tr>
          <tr class="total">
            <td><strong>Total LU</strong></td>
            <td>-</td><td>-</td><td>-</td><td>-</td>
            <td>24,253,698.33</td><td>-</td><td>-</td>
          </tr>
        </tbody>
      </table>
    </div>
  </section>

  <!-- Tertiary Baguio -->
  <section class="table-group">
    <h2>Tertiary Baguio</h2>
    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>Name</th>
            <th>Gross</th>
            <th>Rejection</th>
            <th>B.O Amount</th>
            <th>Net Sales</th>
            <th>Target</th>
            <th>%</th>
            <th>Balance</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>Jehu Romero</td>
            <td>-</td><td>-</td><td>-</td><td>-</td>
            <td>14,978,896.84</td><td>-</td><td>-</td>
          </tr>
          <tr>
            <td>MC ARDEL CACHICHO</td>
            <td>-</td><td>-</td><td>-</td><td>-</td>
            <td>6,231,106.82</td><td>-</td><td>-</td>
          </tr>
          <tr>
            <td>Rocky Fowaya</td>
            <td>-</td><td>-</td><td>-</td><td>-</td>
            <td>14,687,157.84</td><td>-</td><td>-</td>
          </tr>
          <tr class="total">
            <td><strong>Total Baguio</strong></td>
            <td>-</td><td>-</td><td>-</td><td>-</td>
            <td>35,896,558.97</td><td>-</td><td>-</td>
          </tr>
        </tbody>
      </table>
    </div>
  </section>

  <!-- ===== Dropdown + Dashboard Update Script ===== -->
  <script>
    // ---------- Helpers ----------
    const fmt = (n) =>
      (isFinite(n) ? Number(n) : 0).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 3 });

    const num = (txt) => parseFloat(String(txt || "").replace(/,/g, "")) || 0;

    function setCellText(cell, value) {
      if (!cell) return;
      cell.textContent = fmt(value);
    }

    // ---------- Dropdown ----------
    const menuIcon = document.querySelector(".menu-icon");
    const dropdownMenu = document.getElementById("dropdownMenu");
    menuIcon.addEventListener("click", () => {
      dropdownMenu.style.display = dropdownMenu.style.display === "block" ? "none" : "block";
    });
    window.addEventListener("click", (e) => {
      if (!e.target.closest(".menu-container")) dropdownMenu.style.display = "none";
    });

    // ---------- Nav placeholders ----------
    document.getElementById("totalSalesLink").addEventListener("click", () => alert("Total Sales page coming soon!"));
    document.getElementById("dspSalesLink").addEventListener("click", () => alert("DSP-Sales page coming soon!"));
    document.getElementById("focus30Link").addEventListener("click", () => alert("Focus 30 page coming soon!"));

    // ---------- Logout Redirect ----------
    const logoutLink = document.querySelector('.dropdown-menu a[href="logout.html"]');
    if (logoutLink) {
      logoutLink.addEventListener("click", function (event) {
        event.preventDefault();
        window.location.href = "https://chadd-cod07.github.io/km6-login/";
      });
    }

    // ---------- Date & Day KPIs ----------
    function updateDayKPIs() {
      const now = new Date();
      const dateStr = now.toLocaleDateString(undefined, { weekday: "short", month: "short", day: "numeric", year: "numeric" });
      document.querySelector(".summary .date").textContent = dateStr;

      const sellingDays = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate(); // days in month
      const actualDays = now.getDate();
      const progress = Math.round((actualDays / sellingDays) * 100);
      const remaining = Math.max(0, sellingDays - actualDays);

      document.getElementById("sellingDays").textContent = sellingDays;
      document.getElementById("actualDays").textContent = actualDays;
      document.getElementById("progressPct").textContent = `${progress}%`;
      document.getElementById("remainingDays").textContent = remaining;
    }

    // ---------- Dashboard Auto Update ----------
    window.addEventListener("DOMContentLoaded", () => {
      updateDayKPIs();

      const totals = JSON.parse(localStorage.getItem("dashboardTotals") || "{}");
      const fsTotals = JSON.parse(localStorage.getItem("fsTotals") || "{}"); // keyed by EMPLOYEE NAME (UPPER)

      // --- Update Branch Summary ---
      const branchRows = document.querySelectorAll("section.table-section table tbody tr");
      let km6Net = 0, kmlNet = 0;

      branchRows.forEach(row => {
        const branch = row.cells[0]?.innerText.trim().toUpperCase();
        if (!branch) return;

        // Target and optional BO are already in HTML
        const target = num(row.cells[5]?.innerText);

        if (branch.includes("BAGUIO") || branch.includes("KM6")) {
          if (totals?.KM6) {
            setCellText(row.cells[1], totals.KM6.gross);
            setCellText(row.cells[2], totals.KM6.reject);
            setCellText(row.cells[3], totals.KM6.bo);
            setCellText(row.cells[4], totals.KM6.net);
            km6Net = totals.KM6.net;

            const pct = target ? (totals.KM6.net / target) * 100 : 0;
            row.cells[6].textContent = `${pct.toFixed(2)}%`;
            const balance = totals.KM6.net - target;
            row.cells[7].textContent = (balance < 0 ? "(" : "") + fmt(Math.abs(balance)) + (balance < 0 ? ")" : "");
            row.cells[7].style.color = balance < 0 ? "red" : "green";
          }
        } else if (branch.includes("LA UNION") || branch.includes("KML")) {
          if (totals?.KML) {
            setCellText(row.cells[1], totals.KML.gross);
            setCellText(row.cells[2], totals.KML.reject);
            setCellText(row.cells[3], totals.KML.bo);
            setCellText(row.cells[4], totals.KML.net);
            kmlNet = totals.KML.net;

            const pct = target ? (totals.KML.net / target) * 100 : 0;
            row.cells[6].textContent = `${pct.toFixed(2)}%`;
            const balance = totals.KML.net - target;
            row.cells[7].textContent = (balance < 0 ? "(" : "") + fmt(Math.abs(balance)) + (balance < 0 ? ")" : "");
            row.cells[7].style.color = balance < 0 ? "red" : "green";
          }
        } else if (branch.includes("TOTAL")) {
          // Sum up KM6 + KML for Total KM6
          const totalNet = km6Net + kmlNet;
          setCellText(row.cells[4], totalNet);

          const targetTotal = num(row.cells[5]?.innerText);
          const pct = targetTotal ? (totalNet / targetTotal) * 100 : 0;
          row.cells[6].textContent = `${pct.toFixed(2)}%`;

          const balance = totalNet - targetTotal;
          row.cells[7].textContent = (balance < 0 ? "(" : "") + fmt(Math.abs(balance)) + (balance < 0 ? ")" : "");
          row.cells[7].style.color = balance < 0 ? "red" : "green";
        }
      });

      // --- Update FS sections (KCM, LU, Baguio) ---
      const groups = document.querySelectorAll("section.table-group");
      groups.forEach(group => {
        const rows = group.querySelectorAll("tbody tr");
        let sumGross = 0, sumRej = 0, sumBO = 0, sumNet = 0;
        let totalRow = null;

        rows.forEach(row => {
          const nameCell = row.cells[0];
          if (!nameCell) return;

          const label = nameCell.innerText.trim().toUpperCase();

          if (label.startsWith("TOTAL")) {
            totalRow = row;
            return;
          }

          // pull FS values if available
          const fs = fsTotals[label];
          if (fs) {
            setCellText(row.cells[1], fs.gross);
            setCellText(row.cells[2], fs.reject);
            setCellText(row.cells[3], fs.bo);
            setCellText(row.cells[4], fs.net);

            const target = num(row.cells[5]?.innerText);
            const pct = target ? (fs.net / target) * 100 : 0;
            row.cells[6].textContent = `${pct.toFixed(2)}%`;

            const balance = fs.net - target;
            row.cells[7].textContent = (balance < 0 ? "(" : "") + fmt(Math.abs(balance)) + (balance < 0 ? ")" : "");
            row.cells[7].style.color = balance < 0 ? "red" : "green";

            sumGross += fs.gross || 0;
            sumRej  += fs.reject || 0;
            sumBO   += fs.bo || 0;
            sumNet  += fs.net || 0;
          } else {
            // If no data for the FS, keep dashes
          }
        });

        if (totalRow) {
          setCellText(totalRow.cells[1], sumGross);
          setCellText(totalRow.cells[2], sumRej);
          setCellText(totalRow.cells[3], sumBO);
          setCellText(totalRow.cells[4], sumNet);

          const target = num(totalRow.cells[5]?.innerText);
          const pct = target ? (sumNet / target) * 100 : 0;
          totalRow.cells[6].textContent = `${pct.toFixed(2)}%`;

          const balance = sumNet - target;
          totalRow.cells[7].textContent = (balance < 0 ? "(" : "") + fmt(Math.abs(balance)) + (balance < 0 ? ")" : "");
          totalRow.cells[7].style.color = balance < 0 ? "red" : "green";
        }
      });
    });
    // === Auto-sum for "Total KM6" row ===
window.addEventListener("load", () => {
  const saved = localStorage.getItem("dashboardTotals");
  if (!saved) return;

  const totals = JSON.parse(saved);
  const rows = document.querySelectorAll(".table-section table tbody tr");

  rows.forEach((row) => {
    const branch = row.cells[0]?.innerText.trim().toUpperCase();
    if (branch && branch.includes("TOTAL KM6")) {
      const gross = (totals.KM6.gross || 0) + (totals.KML.gross || 0);
      const reject = (totals.KM6.reject || 0) + (totals.KML.reject || 0);
      const bo = (totals.KM6.bo || 0) + (totals.KML.bo || 0);
      const net = (totals.KM6.net || 0) + (totals.KML.net || 0);
      const target = parseFloat(row.cells[5].innerText.replace(/,/g, "")) || 0;

      row.cells[1].innerText = gross.toLocaleString(undefined, { minimumFractionDigits: 3 });
      row.cells[2].innerText = reject.toLocaleString(undefined, { minimumFractionDigits: 3 });
      row.cells[3].innerText = bo.toLocaleString(undefined, { minimumFractionDigits: 3 });
      row.cells[4].innerText = net.toLocaleString(undefined, { minimumFractionDigits: 3 });

      const percent = target ? (net / target) * 100 : 0;
      row.cells[6].innerText = percent.toFixed(2) + "%";

      const balance = net - target;
      row.cells[7].innerText =
        (balance < 0 ? "(" : "") +
        Math.abs(balance).toLocaleString(undefined, { minimumFractionDigits: 3 }) +
        (balance < 0 ? ")" : "");
      row.cells[7].style.color = balance < 0 ? "red" : "green";
    }
  });
});
  </script>
  <script>
window.addEventListener("load", () => {
  // Retrieve saved data
  const totals = JSON.parse(localStorage.getItem("dashboardTotals") || "{}");
  const fsTotals = JSON.parse(localStorage.getItem("fsTotals") || "{}");

  if (Object.keys(totals).length === 0) {
    console.warn("‚ö†Ô∏è No saved dashboard data found. Please upload a new Excel file.");
    return;
  }

  console.log("‚úÖ Restored saved data:", totals, fsTotals);

  // === Update Branch Summary ===
  document.querySelectorAll(".table-section table tbody tr").forEach((row) => {
    const branch = row.cells[0]?.innerText.trim().toUpperCase();
    if (!branch) return;

    if (branch.includes("BAGUIO")) {
      row.cells[1].innerText = totals.KM6.gross.toLocaleString();
      row.cells[2].innerText = totals.KM6.reject.toLocaleString();
      row.cells[3].innerText = totals.KM6.bo.toLocaleString();
      row.cells[4].innerText = totals.KM6.net.toLocaleString();
    }
    if (branch.includes("LA UNION")) {
      row.cells[1].innerText = totals.KML.gross.toLocaleString();
      row.cells[2].innerText = totals.KML.reject.toLocaleString();
      row.cells[3].innerText = totals.KML.bo.toLocaleString();
      row.cells[4].innerText = totals.KML.net.toLocaleString();
    }
  });

  // === Update Salesperson Tables ===
  document.querySelectorAll(".table-section table tbody tr").forEach((row) => {
    const fsName = row.cells[0]?.innerText.trim().toUpperCase();
    if (fsTotals[fsName]) {
      const fs = fsTotals[fsName];
      row.cells[1].innerText = fs.gross.toLocaleString();
      row.cells[2].innerText = fs.reject.toLocaleString();
      row.cells[3].innerText = fs.bo.toLocaleString();
      row.cells[4].innerText = fs.net.toLocaleString();
    }
  });
});
</script>
<!-- === Firebase Cloud Load for Dashboard === -->
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore-compat.js"></script>
<script>
  // Initialize Firebase (must match your upload.html)
  const firebaseConfig = {
    apiKey: "AIzaSyCStpCWdRO770N4SpH3GKYwp9pg1kP6_O4",
    authDomain: "km6-dashboard.firebaseapp.com",
    projectId: "km6-dashboard",
    storageBucket: "km6-dashboard.firebasestorage.app",
    messagingSenderId: "309068846407",
    appId: "1:309068846407:web:68d51a21f6ab238fa1a862"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // Load dashboard totals from Firebase
  async function loadDashboardData() {
    try {
      const totalsDoc = await db.collection("km6_dashboard_data").doc("dashboardTotals").get();
      const fsDoc = await db.collection("km6_dashboard_data").doc("fsTotals").get();

      if (totalsDoc.exists && fsDoc.exists) {
        const totals = totalsDoc.data();
        const fsTotals = fsDoc.data();

        console.log("‚òÅÔ∏è Loaded data from Firebase:", totals, fsTotals);

        // Save to localStorage (optional, for offline)
        localStorage.setItem("dashboardTotals", JSON.stringify(totals));
        localStorage.setItem("fsTotals", JSON.stringify(fsTotals));

        // üîÅ Optional: update your dashboard display automatically
        updateDashboard(totals, fsTotals);
      } else {
        console.warn("‚ö†Ô∏è No data found in Firebase yet.");
      }
    } catch (error) {
      console.error("‚ùå Error loading Firebase data:", error);
    }
  }

  // Example dashboard update (customize this for your layout)
  function updateDashboard(totals, fsTotals) {
    const fmt = n => Number(n || 0).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 3 });
    document.getElementById("km6Gross").textContent = fmt(totals.KM6.gross);
    document.getElementById("km6Reject").textContent = fmt(totals.KM6.reject);
    document.getElementById("km6BO").textContent = fmt(totals.KM6.bo);
    document.getElementById("km6Net").textContent = fmt(totals.KM6.net);
    document.getElementById("kmlGross").textContent = fmt(totals.KML.gross);
    document.getElementById("kmlReject").textContent = fmt(totals.KML.reject);
    document.getElementById("kmlBO").textContent = fmt(totals.KML.bo);
    document.getElementById("kmlNet").textContent = fmt(totals.KML.net);
  }

  // Run on page load
  loadDashboardData();
</script>
<!-- Firebase live sync (append at very end) -->
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore-compat.js"></script>
<script>
  // === Firebase init (same project as upload.html) ===
  const firebaseConfig = {
    apiKey: "AIzaSyCStpCWdRO770N4SpH3GKYwp9pg1kP6_O4",
    authDomain: "km6-dashboard.firebaseapp.com",
    projectId: "km6-dashboard",
    storageBucket: "km6-dashboard.appspot.com",   // ‚úÖ appspot.com (not firebasestorage.app)
    messagingSenderId: "309068846407",
    appId: "1:309068846407:web:68d51a21f6ab238fa1a862"
  };
  if (firebase.apps.length === 0) firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // Helpers
  const fmt = (n) => Number(n || 0).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
  const num = (txt) => parseFloat(String(txt || "").replace(/,/g, "")) || 0;
  const safeSet = (id, value) => { const el = document.getElementById(id); if (el) el.textContent = fmt(value); };

  // === 2.1 Totals live listener ===
  db.collection("km6_dashboard_data").doc("dashboardTotals").onSnapshot((snap) => {
    if (!snap.exists) { console.warn("No dashboardTotals in Firebase yet."); return; }
    const totals = snap.data();
    console.log("‚úÖ Totals (live):", totals);

    // Paint branch summary cells
    safeSet("km6Gross", totals.KM6?.gross);
    safeSet("km6Reject", totals.KM6?.reject);
    safeSet("km6BO",    totals.KM6?.bo);
    safeSet("km6Net",   totals.KM6?.net);

    safeSet("kmlGross", totals.KML?.gross);
    safeSet("kmlReject",totals.KML?.reject);
    safeSet("kmlBO",    totals.KML?.bo);
    safeSet("kmlNet",   totals.KML?.net);

    // Save for your existing offline logic
    localStorage.setItem("dashboardTotals", JSON.stringify(totals));

    // Recompute % and Balance using your existing targets in the table
    const rows = document.querySelectorAll("section.table-section table tbody tr");
    let km6Net=0, kmlNet=0;
    rows.forEach(row => {
      const label = row.cells[0]?.innerText.trim().toUpperCase();
      if (!label) return;

      if (label.includes("BAGUIO") || label.includes("KM6")) {
        const target = num(row.cells[5]?.innerText);
        const net = totals.KM6?.net || 0;
        km6Net = net;
        row.cells[6].textContent = target ? (net/target*100).toFixed(2)+"%" : "-";
        const bal = net - target;
        row.cells[7].textContent = (bal<0?"(":"") + fmt(Math.abs(bal)) + (bal<0?")":"");
        row.cells[7].style.color = bal<0 ? "red" : "green";
      }
      if (label.includes("LA UNION") || label.includes("KML")) {
        const target = num(row.cells[5]?.innerText);
        const net = totals.KML?.net || 0;
        kmlNet = net;
        row.cells[6].textContent = target ? (net/target*100).toFixed(2)+"%" : "-";
        const bal = net - target;
        row.cells[7].textContent = (bal<0?"(":"") + fmt(Math.abs(bal)) + (bal<0?")":"");
        row.cells[7].style.color = bal<0 ? "red" : "green";
      }
      if (label.includes("TOTAL KM6")) {
        const netTotal = km6Net + kmlNet;
        // Paint the Net cell in your "Total KM6" row (col 5, zero-based index 4)
        if (row.cells[4]) row.cells[4].textContent = fmt(netTotal);
        const target = num(row.cells[5]?.innerText);
        row.cells[6].textContent = target ? (netTotal/target*100).toFixed(2)+"%" : "-";
        const bal = netTotal - target;
        row.cells[7].textContent = (bal<0?"(":"") + fmt(Math.abs(bal)) + (bal<0?")":"");
        row.cells[7].style.color = bal<0 ? "red" : "green";
      }
    });

    // Update timestamp
    const ts = new Date().toLocaleString();
    const stamp = document.getElementById("lastUpdated");
    if (stamp) stamp.textContent = "Last updated: " + ts;
  });

  // === 2.2 FS totals live listener (updates rows under KCM/LU/Baguio groups) ===
  db.collection("km6_dashboard_data").doc("fsTotals").onSnapshot((snap) => {
    if (!snap.exists) { console.warn("No fsTotals in Firebase yet."); return; }
    const fsTotals = snap.data();
    console.log("‚úÖ FS (live):", fsTotals);
    localStorage.setItem("fsTotals", JSON.stringify(fsTotals));

    // Walk all rows in every .table-group (your three FS sections)
    document.querySelectorAll("section.table-group tbody tr").forEach(row => {
      const label = row.cells[0]?.innerText.trim().toUpperCase();
      if (!label || label.startsWith("TOTAL")) return;
      const fs = fsTotals[label];
      if (!fs) return;

      // Paint detail row
      if (row.cells[1]) row.cells[1].textContent = fmt(fs.gross);
      if (row.cells[2]) row.cells[2].textContent = fmt(fs.reject);
      if (row.cells[3]) row.cells[3].textContent = fmt(fs.bo);
      if (row.cells[4]) row.cells[4].textContent = fmt(fs.net);

      // Target, %, Balance (if you have targets in col 6)
      const target = row.cells[5] ? num(row.cells[5].innerText) : 0;
      if (row.cells[6]) row.cells[6].textContent = target ? (fs.net/target*100).toFixed(2)+"%" : "-";
      if (row.cells[7]) {
        const bal = fs.net - target;
        row.cells[7].textContent = (bal<0?"(":"") + fmt(Math.abs(bal)) + (bal<0?")":"");
        row.cells[7].style.color = bal<0 ? "red" : "green";
      }
    });

    // Recompute each group's TOTAL row
    document.querySelectorAll("section.table-group").forEach(group => {
      const rows = group.querySelectorAll("tbody tr");
      let g=0,r=0,b=0,n=0;
      let totalRow=null;
      rows.forEach(row=>{
        const label = row.cells[0]?.innerText.trim().toUpperCase();
        if (!label) return;
        if (label.startsWith("TOTAL")) { totalRow=row; return; }
        const fs = fsTotals[label];
        if (fs) { g+=fs.gross||0; r+=fs.reject||0; b+=fs.bo||0; n+=fs.net||0; }
      });
      if (totalRow) {
        if (totalRow.cells[1]) totalRow.cells[1].textContent = fmt(g);
        if (totalRow.cells[2]) totalRow.cells[2].textContent = fmt(r);
        if (totalRow.cells[3]) totalRow.cells[3].textContent = fmt(b);
        if (totalRow.cells[4]) totalRow.cells[4].textContent = fmt(n);

        const target = totalRow.cells[5] ? num(totalRow.cells[5].innerText) : 0;
        if (totalRow.cells[6]) totalRow.cells[6].textContent = target ? (n/target*100).toFixed(2)+"%" : "-";
        if (totalRow.cells[7]) {
          const bal = n - target;
          totalRow.cells[7].textContent = (bal<0?"(":"") + fmt(Math.abs(bal)) + (bal<0?")":"");
          totalRow.cells[7].style.color = bal<0 ? "red" : "green";
        }
      }
    });
  });

  // Keep your existing dropdown / logout / KPI scripts ‚Äî no change needed.
</script>
</body>
</html>
