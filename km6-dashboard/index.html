<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>KM6 Sales Dashboard</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    body{font-family:Arial,Helvetica,sans-serif;background:#f8f9fa;margin:0}
    header{background:#fdb913;color:#111;padding:14px 22px;display:flex;align-items:center;justify-content:space-between}
    .logo h1{font-size:18px;margin:0}
    .header-right h2{display:inline-block;margin:0 12px;font-size:16px}
    .header-right a{color:#111;text-decoration:none}
    .menu-container{position:relative;display:inline-block;margin-left:6px}
    .menu-icon{font-size:22px;cursor:pointer;user-select:none}
    .dropdown-menu{display:none;position:absolute;right:0;top:28px;background:#fff;width:210px;border-radius:10px;box-shadow:0 8px 18px rgba(0,0,0,.15);overflow:hidden;z-index:999}
    .dropdown-menu a{display:flex;gap:8px;align-items:center;padding:11px 14px;color:#222;text-decoration:none}
    .dropdown-menu a:hover{background:#f3f4f6}
    h2{color:#00843d;text-align:center;margin:18px 0}
    .summary h2 .date{color:#d32f2f}
    .info{text-align:center}
    .compare-section{width:95%;max-width:1100px;margin:18px auto 8px}
    .compare-cards{display:flex;gap:14px;justify-content:center;flex-wrap:wrap}
    .card{background:#fff;border-radius:12px;box-shadow:0 2px 6px rgba(0,0,0,.08);padding:18px 18px 16px;width:300px;text-align:center}
    .card h3{color:#00843d;margin:0 0 10px}
    .up{color:#00843d;font-weight:700}
    .down{color:#c62828;font-weight:700}
    .updated-time{font-size:.9em;color:#555;text-align:center;margin:6px 0 0}
    .table-section,.table-group{width:95%;max-width:1300px;margin:18px auto}
    .table-group h2{display:flex;align-items:center;gap:8px}
    .table-container{width:100%;overflow-x:auto;-webkit-overflow-scrolling:touch}
    table{width:100%;border-collapse:collapse;min-width:900px}
    th,td{padding:10px 8px;text-align:left;white-space:nowrap}
    th{background:#00843d;color:#fff}
    .total td{background:#eef8e9;font-weight:700}
  </style>
</head>
<body>
  <!-- Header -->
  <header class="header">
    <div class="logo"><h1>KM6 General Merchandise</h1></div>
    <div class="header-right">
      <h2><a href="#" id="totalSalesLink">Total Sales</a></h2>
      <h2><a href="#" id="dspSalesLink">DSP-Sales</a></h2>
      <h2><a href="#" id="focus30Link">Focus 30</a></h2>

      <!-- Ordered Menu: Settings ‚Üí Upload ‚Üí Logout -->
      <div class="menu-container">
        <div class="menu-icon">‚ò∞</div>
        <div class="dropdown-menu" id="dropdownMenu">
          <a href="settings.html">‚öôÔ∏è Settings</a>
          <a href="upload.html">üü¶ Upload Excel File</a>
          <a href="logout.html" id="logoutLink">üîí Log Out</a>
        </div>
      </div>
    </div>
  </header>

  <!-- KPIs -->
  <section class="summary">
    <h2>Daily Sales as of <span class="date">--</span></h2>
    <div class="info">
      <p>
        <strong>Selling Days:</strong> <span id="sellingDays">0</span> &nbsp;|&nbsp;
        <strong>Actual Days:</strong> <span id="actualDays">0</span> &nbsp;|&nbsp;
        <strong>Progress:</strong> <span id="progressPct">0%</span> &nbsp;|&nbsp;
        <strong>Remaining Days:</strong> <span id="remainingDays">0</span>
      </p>
    </div>
  </section>

  <!-- Daily Sales Current vs Previous -->
  <section class="compare-section">
    <h2>Daily Sales Current vs Previous</h2>
    <div class="compare-cards">
      <div class="card">
        <h3>Total KM6</h3>
        <p><strong>Previous Sales:</strong> <span id="prevKM6">-</span></p>
        <p><strong>Current Sales:</strong> <span id="currKM6">-</span></p>
        <p id="changeKM6">-</p>
      </div>
      <div class="card">
        <h3>Total Baguio</h3>
        <p><strong>Previous Sales:</strong> <span id="prevBaguio">-</span></p>
        <p><strong>Current Sales:</strong> <span id="currBaguio">-</span></p>
        <p id="changeBaguio">-</p>
      </div>
      <div class="card">
        <h3>Total La Union</h3>
        <p><strong>Previous Sales:</strong> <span id="prevLU">-</span></p>
        <p><strong>Current Sales:</strong> <span id="currLU">-</span></p>
        <p id="changeLU">-</p>
      </div>
    </div>
  </section>

  <p class="updated-time" id="lastUpdated">Last updated: --</p>

  <!-- Branch Summary -->
  <section class="table-section">
    <h2>Branch Summary</h2>
    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>Branch</th><th>Gross</th><th>Rejection</th><th>B.O Amount</th><th>Net Sales</th>
            <th>Target</th><th>%</th><th>Balance</th>
          </tr>
        </thead>
        <tbody id="branchSummary">
          <tr>
            <td>Baguio</td><td id="km6Gross">-</td><td id="km6Reject">-</td><td id="km6BO">-</td><td id="km6Net">-</td>
            <td id="km6Target">-</td><td id="km6Pct">-</td><td id="km6Bal">-</td>
          </tr>
          <tr>
            <td>La Union</td><td id="kmlGross">-</td><td id="kmlReject">-</td><td id="kmlBO">-</td><td id="kmlNet">-</td>
            <td id="kmlTarget">-</td><td id="kmlPct">-</td><td id="kmlBal">-</td>
          </tr>
          <tr class="total">
            <td><strong>Total KM6</strong></td>
            <td id="totGross">-</td><td id="totReject">-</td><td id="totBO">-</td><td id="totNet">-</td>
            <td id="totTarget">-</td><td id="totPct">-</td><td id="totBal">-</td>
          </tr>
        </tbody>
      </table>
    </div>
  </section>

  <!-- FS: Total KCM -->
  <section class="table-group">
    <h2><span style="color:#f0b400">‚îÇ</span> Total KCM</h2>
    <div class="table-container">
      <table>
        <thead>
          <tr><th>KCM</th><th>Gross</th><th>Rejection</th><th>B.O AMOUNT</th><th>Net Sales</th><th>Target</th><th>%</th><th>Balance</th></tr>
        </thead>
        <tbody id="tblKCM">
          <tr><td>Jim Russel Peralta</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td></tr>
          <tr><td>Judy Ann Mabanta</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td></tr>
          <tr><td>Gilbert Aquino</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td></tr>
          <tr><td>Roderick Dacay</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td></tr>
          <tr><td>Gyver Gano</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td></tr>
          <tr class="total"><td><strong>Total KCM</strong></td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td></tr>
        </tbody>
      </table>
    </div>
  </section>

  <!-- FS: Tertiary La Union (KML) -->
  <section class="table-group">
    <h2 style="color:#b71c1c">Tertiary La Union (KML)</h2>
    <div class="table-container">
      <table>
        <thead>
          <tr><th>Name</th><th>Gross</th><th>Rejection</th><th>B.O AMOUNT</th><th>Net Sales</th><th>Target</th><th>%</th><th>Balance</th></tr>
        </thead>
        <tbody id="tblLU">
          <tr><td>Gemma Jacaban</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td></tr>
          <tr><td>Jovelyn Castro</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td></tr>
          <tr class="total"><td><strong>Total LU</strong></td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td></tr>
        </tbody>
      </table>
    </div>
  </section>

  <!-- FS: Tertiary Baguio (KM6) -->
  <section class="table-group">
    <h2><span style="color:#f0b400">‚îÇ</span> Tertiary Baguio (KM6)</h2>
    <div class="table-container">
      <table>
        <thead>
          <tr><th>Name</th><th>Gross</th><th>Rejection</th><th>B.O AMOUNT</th><th>Net Sales</th><th>Target</th><th>%</th><th>Balance</th></tr>
        </thead>
        <tbody id="tblBG">
          <tr><td>Jehu Romero</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td></tr>
          <tr><td>MC ARDEL CACHICHO</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td></tr>
          <tr><td>Rocky Fowaya</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td></tr>
          <tr class="total"><td><strong>Total Baguio</strong></td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td></tr>
        </tbody>
      </table>
    </div>
  </section>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore-compat.js"></script>
<script>
/* -----------------------------------------------------------
   üî• FIREBASE INITIALIZATION
----------------------------------------------------------- */
const firebaseConfig = {
  apiKey: "AIzaSyCStpCWdRO770N4SpH3GKYwp9pg1kP6_O4",
  authDomain: "km6-dashboard.firebaseapp.com",
  projectId: "km6-dashboard",
  storageBucket: "km6-dashboard.appspot.com",
  messagingSenderId: "309068846407",
  appId: "1:309068846407:web:68d51a21f6ab238fa1a862",
};
if (firebase.apps.length === 0) firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

/* -----------------------------------------------------------
   üßÆ HELPER FUNCTIONS
----------------------------------------------------------- */
const fmt = n => Number(n || 0).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
const num = v => parseFloat(String(v || "0").replace(/[^0-9.-]/g, "")) || 0;
const U = s => String(s || "").trim().toUpperCase();

/* -----------------------------------------------------------
   ‚ò∞ MENU DROPDOWN BEHAVIOR
----------------------------------------------------------- */
const menuIcon = document.querySelector(".menu-icon");
const dropdownMenu = document.getElementById("dropdownMenu");
menuIcon.addEventListener("click", () => {
  dropdownMenu.style.display = dropdownMenu.style.display === "block" ? "none" : "block";
});
window.addEventListener("click", (e) => {
  if (!e.target.closest(".menu-container")) dropdownMenu.style.display = "none";
});

const logoutLink = document.getElementById("logoutLink");
if (logoutLink) {
  logoutLink.addEventListener("click", (e) => {
    e.preventDefault();
    window.location.href = "https://chadd-cod07.github.io/km6-login/";
  });
}

/* -----------------------------------------------------------
   üìÖ DATE HEADER INFO
----------------------------------------------------------- */
(function updateKPIs(){
  const now = new Date();
  document.querySelector(".summary .date").textContent = now.toLocaleDateString(undefined, { weekday:"short", month:"short", day:"numeric", year:"numeric" });
  const sellingDays = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();
  const actual = now.getDate();
  document.getElementById("sellingDays").textContent = sellingDays;
  document.getElementById("actualDays").textContent = actual;
  document.getElementById("progressPct").textContent = Math.round(actual/sellingDays*100) + "%";
  document.getElementById("remainingDays").textContent = sellingDays - actual;
})();

/* -----------------------------------------------------------
   üß© AUTO COMPUTATION (Reflects Uploaded Excel Data)
----------------------------------------------------------- */
async function waitForUploads() {
  return new Promise(resolve => {
    const check = () => {
      const dw = localStorage.getItem("dataweb");
      const pn = localStorage.getItem("pnetinv");
      const id = localStorage.getItem("invoicedate");
      if (dw && pn && id) resolve(true);
      else setTimeout(check, 1000);
    };
    check();
  });
}

async function computeKM6Dashboard() {
  await waitForUploads();
// Keep your existing 3 lines
const dataweb = JSON.parse(localStorage.getItem("dataweb") || "[]");
const pnetinv = JSON.parse(localStorage.getItem("pnetinv") || "[]");
const invoicedate = JSON.parse(localStorage.getItem("invoicedate") || "[]");

// üîπ Add these new lines to handle FS totals + Target sheet
const fsTotals = JSON.parse(localStorage.getItem("fsTotals") || "{}");
const targets = JSON.parse(localStorage.getItem("targets") || "{}");

// Debugging logs for clarity
console.log("üìò dataweb (Gross):", dataweb);
console.log("üìó pnetinv (P_Net.Inv):", pnetinv);
console.log("üìô invoicedate (Invoice Date):", invoicedate);
console.log("üìí fsTotals (FS Computed):", fsTotals);
console.log("üéØ targets (TargetSales):", targets);

  if (!dataweb.length && !pnetinv.length) {
    console.warn("‚ö†Ô∏è No uploaded Excel data found.");
    return;
  }

  console.log("üîÑ Computing dashboard from uploaded Excel data...");

  // Initialize totals
  let totals = {
    KM6: { gross: 0, reject: 0, bo: 0, net: 0, target: 0 },
    KML: { gross: 0, reject: 0, bo: 0, net: 0, target: 0 },
  };

  // --- Gross & Target (dataweb)
  dataweb.forEach(r => {
    const branch = (r["Branch Name"] || "").toUpperCase().trim();
    const gross = num(r["Sum of Order Amount"]);
    if (branch === "KM6") totals.KM6.gross += gross;
    if (branch === "KML") totals.KML.gross += gross;
  });
  totals.KM6.target = totals.KM6.gross;
  totals.KML.target = totals.KML.gross;

  // --- Rejection / BO / Net (pnetinv)
  pnetinv.forEach(r => {
    const branch = (r["Branch Name"] || "").toUpperCase().trim();
    const rej = num(r["TOTAL REJECTION"]);
    const bo = num(r["TOTAL BO"]);
    const netv = num(r["TOTAL NET"]);
    if (branch === "KM6") {
      totals.KM6.reject += rej; totals.KM6.bo += bo; totals.KM6.net += netv;
    } else if (branch === "KML") {
      totals.KML.reject += rej; totals.KML.bo += bo; totals.KML.net += netv;
    }
  });

  // --- Combine totals
  const totalGross = totals.KM6.gross + totals.KML.gross;
  const totalRej = totals.KM6.reject + totals.KML.reject;
  const totalBO = totals.KM6.bo + totals.KML.bo;
  const totalNet = totals.KM6.net + totals.KML.net;
  const totalTarget = totals.KM6.target + totals.KML.target;

  // --- Render table
  const set = (id, val) => { const el = document.getElementById(id); if (el) el.textContent = fmt(val); };

  // KM6
  set("km6Gross", totals.KM6.gross);
  set("km6Reject", totals.KM6.reject);
  set("km6BO", totals.KM6.bo);
  set("km6Net", totals.KM6.net);
  set("km6Target", totals.KM6.target);
  document.getElementById("km6Pct").textContent = totals.KM6.target ? ((totals.KM6.net / totals.KM6.target) * 100).toFixed(2) + "%" : "-";
  set("km6Bal", totals.KM6.target - totals.KM6.net);

  // KML
  set("kmlGross", totals.KML.gross);
  set("kmlReject", totals.KML.reject);
  set("kmlBO", totals.KML.bo);
  set("kmlNet", totals.KML.net);
  set("kmlTarget", totals.KML.target);
  document.getElementById("kmlPct").textContent = totals.KML.target ? ((totals.KML.net / totals.KML.target) * 100).toFixed(2) + "%" : "-";
  set("kmlBal", totals.KML.target - totals.KML.net);

  // TOTAL
  set("totGross", totalGross);
  set("totReject", totalRej);
  set("totBO", totalBO);
  set("totNet", totalNet);
  set("totTarget", totalTarget);
  document.getElementById("totPct").textContent = totalTarget ? ((totalNet / totalTarget) * 100).toFixed(2) + "%" : "-";
  set("totBal", totalTarget - totalNet);

  // --- Daily Sales cards (invoicedate)
  if (invoicedate.length > 1) {
    const last = invoicedate[invoicedate.length - 1];
    const prev = invoicedate[invoicedate.length - 2];
    const km6Curr = num(last["KM6"]) + num(last["KML"]);
    const km6Prev = num(prev["KM6"]) + num(prev["KML"]);
    const pct = km6Prev ? ((km6Curr - km6Prev) / km6Prev) * 100 : 0;

    const change = (idPrev, idCurr, idChange, prevVal, currVal) => {
      const elP = document.getElementById(idPrev), elC = document.getElementById(idCurr), elCh = document.getElementById(idChange);
      if (elP) elP.textContent = fmt(prevVal);
      if (elC) elC.textContent = fmt(currVal);
      if (elCh) {
        elCh.textContent = (pct >= 0 ? "‚ñ≤ " : "‚ñº ") + Math.abs(pct).toFixed(2) + "%";
        elCh.className = pct >= 0 ? "up" : "down";
      }
    };
    change("prevKM6", "currKM6", "changeKM6", km6Prev, km6Curr);
    change("prevBaguio", "currBaguio", "changeBaguio", num(prev["KM6"]), num(last["KM6"]));
    change("prevLU", "currLU", "changeLU", num(prev["KML"]), num(last["KML"]));
  }

  // --- Save to Firebase
  db.collection("km6_dashboard_data").doc("dashboardTotals").set({
    KM6: totals.KM6,
    KML: totals.KML,
    TOTAL: { gross: totalGross, reject: totalRej, bo: totalBO, net: totalNet },
    updated: new Date().toLocaleString(),
  });

  const stamp = document.getElementById("lastUpdated");
  if (stamp) stamp.textContent = "Last updated: " + new Date().toLocaleString();

  console.log("‚úÖ Dashboard updated and synced with Firebase");

  // Now render FS tables
  renderFSTables();
}

/* -----------------------------------------------------------
   üß© NEW FUNCTION - RENDER FS TABLES (KCM, KML, KM6)
----------------------------------------------------------- */
function renderFSTables() {
  const fsTotals = JSON.parse(localStorage.getItem("fsTotals") || "{}");
  const fmt = n => Number(n || 0).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
  const num = v => parseFloat(String(v || "0").replace(/[^0-9.-]/g, "")) || 0;

  const groups = {
    KCM: ["Jim Russel Peralta", "Judy Ann Mabanta", "Gilbert Aquino", "Roderick Dacay", "Gyver Gano"],
    KML: ["Gemma Jacaban", "Jovelyn Castro"],
    BG: ["Jehu Romero", "MC ARDEL CACHICHO", "Rocky Fowaya"]
  };

  for (const [group, names] of Object.entries(groups)) {
    const tbody = document.querySelector(`#tbl${group}`);
    if (!tbody) continue;
    const totalRow = tbody.querySelector(".total");
    tbody.innerHTML = "";
    if (totalRow) tbody.appendChild(totalRow);
    let total = { gross: 0, reject: 0, bo: 0, net: 0 };

    names.forEach(name => {
      const data = fsTotals[name.toUpperCase()] || {};
      const gross = num(data.gross);
      const rej = num(data.reject);
      const bo = num(data.bo);
      const net = num(data.net);
      total.gross += gross;
      total.reject += rej;
      total.bo += bo;
      total.net += net;

      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${name}</td><td>${fmt(gross)}</td><td>${fmt(rej)}</td><td>${fmt(bo)}</td><td>${fmt(net)}</td><td>-</td><td>-</td><td>-</td>`;
      tbody.insertBefore(tr, totalRow);
    });

    totalRow.innerHTML = `<td><strong>Total ${group}</strong></td><td>${fmt(total.gross)}</td><td>${fmt(total.reject)}</td><td>${fmt(total.bo)}</td><td>${fmt(total.net)}</td><td>-</td><td>-</td><td>-</td>`;
  }

  console.log("‚úÖ FS Tables updated successfully");
}

/* -----------------------------------------------------------
   üïí INITIAL LOAD + AUTO REFRESH
----------------------------------------------------------- */
computeKM6Dashboard();

window.addEventListener("storage", (e) => {
  if (["dataweb", "pnetinv", "invoicedate", "fsTotals"].includes(e.key)) {
    computeKM6Dashboard();
  }
});
</script>

</body>
</html>
