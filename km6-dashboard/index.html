<!DOCTYPE html>
<html lang="en">
<head>
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>KM6 Sales Dashboard</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    body{font-family:Arial,Helvetica,sans-serif;background:#f8f9fa;margin:0}
    header{background:#fdb913;color:#111;padding:14px 22px;display:flex;align-items:center;justify-content:space-between}
    .logo h1{font-size:18px;margin:0}
    .header-right h2{display:inline-block;margin:0 12px;font-size:16px}
    .header-right a{color:#111;text-decoration:none}
    .menu-container{position:relative;display:inline-block;margin-left:6px}
    .menu-icon{font-size:22px;cursor:pointer;user-select:none}
    .dropdown-menu{display:none;position:absolute;right:0;top:28px;background:#fff;width:210px;border-radius:10px;box-shadow:0 8px 18px rgba(0,0,0,.15);overflow:hidden;z-index:999}
    .dropdown-menu a{display:flex;gap:8px;align-items:center;padding:11px 14px;color:#222;text-decoration:none}
    .dropdown-menu a:hover{background:#f3f4f6}
    h2{color:#00843d;text-align:center;margin:18px 0}
    .summary h2 .date{color:#d32f2f}
    .info{text-align:center}
    .compare-section{width:95%;max-width:1100px;margin:18px auto 8px}
    .compare-cards{display:flex;gap:14px;justify-content:center;flex-wrap:wrap}
    .card{background:#fff;border-radius:12px;box-shadow:0 2px 6px rgba(0,0,0,.08);padding:18px 18px 16px;width:300px;text-align:center}
    .card h3{color:#00843d;margin:0 0 10px}
    .up{color:#00843d;font-weight:700}
    .down{color:#c62828;font-weight:700}
    .updated-time{font-size:.9em;color:#555;text-align:center;margin:6px 0 0}
    .table-section,.table-group{width:95%;max-width:1300px;margin:18px auto}
    .table-group h2{display:flex;align-items:center;gap:8px}
    .table-container{width:100%;overflow-x:auto;-webkit-overflow-scrolling:touch}
    table{width:100%;border-collapse:collapse;min-width:900px}
    th,td{padding:10px 8px;text-align:left;white-space:nowrap}
    th{background:#00843d;color:#fff}
    .total td{background:#eef8e9;font-weight:700}
  </style>
</head>
<body>
  <!-- Header -->
  <header class="header">
    <div class="logo"><h1>KM6 General Merchandise</h1></div>
    <div class="header-right">
      <h2><a href="#" id="totalSalesLink">Total Sales</a></h2>
      <h2><a href="#" id="dspSalesLink">DSP-Sales</a></h2>
      <h2><a href="#" id="focus30Link">Focus 30</a></h2>

      <!-- Ordered Menu: Settings ‚Üí Upload ‚Üí Logout -->
      <div class="menu-container">
        <div class="menu-icon">‚ò∞</div>
        <div class="dropdown-menu" id="dropdownMenu">
          <a href="settings.html">‚öôÔ∏è Settings</a>
          <a href="upload.html">üü¶ Upload Excel File</a>
          <a href="logout.html" id="logoutLink">üîí Log Out</a>
        </div>
      </div>
    </div>
  </header>

  <!-- KPIs -->
  <section class="summary">
    <h2>Daily Sales as of <span class="date">--</span></h2>
    <div class="info">
      <p>
        <strong>Selling Days:</strong> <span id="sellingDays">0</span> &nbsp;|&nbsp;
        <strong>Actual Days:</strong> <span id="actualDays">0</span> &nbsp;|&nbsp;
        <strong>Progress:</strong> <span id="progressPct">0%</span> &nbsp;|&nbsp;
        <strong>Remaining Days:</strong> <span id="remainingDays">0</span>
      </p>
    </div>
  </section>

  <!-- Daily Sales Current vs Previous -->
  <section class="compare-section">
    <h2>Daily Sales Current vs Previous</h2>
    <div class="compare-cards">
      <div class="card">
        <h3>Total KM6</h3>
        <p><strong>Previous Sales:</strong> <span id="prevKM6">-</span></p>
        <p><strong>Current Sales:</strong> <span id="currKM6">-</span></p>
        <p id="changeKM6">-</p>
      </div>
      <div class="card">
        <h3>Total Baguio</h3>
        <p><strong>Previous Sales:</strong> <span id="prevBaguio">-</span></p>
        <p><strong>Current Sales:</strong> <span id="currBaguio">-</span></p>
        <p id="changeBaguio">-</p>
      </div>
      <div class="card">
        <h3>Total La Union</h3>
        <p><strong>Previous Sales:</strong> <span id="prevLU">-</span></p>
        <p><strong>Current Sales:</strong> <span id="currLU">-</span></p>
        <p id="changeLU">-</p>
      </div>
    </div>
  </section>

  <p class="updated-time" id="lastUpdated">Last updated: --</p>

  <!-- Branch Summary -->
  <section class="table-section">
    <h2>Branch Summary</h2>
    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>Branch</th><th>Gross</th><th>Rejection</th><th>B.O Amount</th><th>Net Sales</th>
            <th>Target</th><th>%</th><th>Balance</th>
          </tr>
        </thead>
        <tbody id="branchSummary">
          <tr>
            <td>Baguio</td><td id="km6Gross">-</td><td id="km6Reject">-</td><td id="km6BO">-</td><td id="km6Net">-</td>
            <td id="km6Target">-</td><td id="km6Pct">-</td><td id="km6Bal">-</td>
          </tr>
          <tr>
            <td>La Union</td><td id="kmlGross">-</td><td id="kmlReject">-</td><td id="kmlBO">-</td><td id="kmlNet">-</td>
            <td id="kmlTarget">-</td><td id="kmlPct">-</td><td id="kmlBal">-</td>
          </tr>
          <tr class="total">
            <td><strong>Total KM6</strong></td>
            <td id="totGross">-</td><td id="totReject">-</td><td id="totBO">-</td><td id="totNet">-</td>
            <td id="totTarget">-</td><td id="totPct">-</td><td id="totBal">-</td>
          </tr>
        </tbody>
      </table>
    </div>
  </section>

  <!-- FS Tables -->
  <section class="table-group">
    <h2><span style="color:#f0b400">‚îÇ</span> Total KCM</h2>
    <div class="table-container">
      <table>
        <thead><tr><th>KCM</th><th>Gross</th><th>Rejection</th><th>B.O AMOUNT</th><th>Net Sales</th><th>Target</th><th>%</th><th>Balance</th></tr></thead>
        <tbody id="tblKCM">
          <tr><td>Jim Russel Peralta</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td></tr>
          <tr><td>Judy Ann Mabanta</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td></tr>
          <tr><td>Gilbert Aquino</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td></tr>
          <tr><td>Roderick Dacay</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td></tr>
          <tr><td>Gyver Gano</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td></tr>
          <tr class="total"><td><strong>Total KCM</strong></td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td></tr>
        </tbody>
      </table>
    </div>
  </section>

  <section class="table-group">
    <h2 style="color:#b71c1c">Tertiary La Union (KML)</h2>
    <div class="table-container">
      <table>
        <thead><tr><th>Name</th><th>Gross</th><th>Rejection</th><th>B.O AMOUNT</th><th>Net Sales</th><th>Target</th><th>%</th><th>Balance</th></tr></thead>
        <tbody id="tblLU">
          <tr><td>Gemma Jacaban</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td></tr>
          <tr><td>Jovelyn Castro</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td></tr>
          <tr class="total"><td><strong>Total LU</strong></td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td></tr>
        </tbody>
      </table>
    </div>
  </section>

  <section class="table-group">
    <h2><span style="color:#f0b400">‚îÇ</span> Tertiary Baguio (KM6)</h2>
    <div class="table-container">
      <table>
        <thead><tr><th>Name</th><th>Gross</th><th>Rejection</th><th>B.O AMOUNT</th><th>Net Sales</th><th>Target</th><th>%</th><th>Balance</th></tr></thead>
        <tbody id="tblBG">
          <tr><td>Jehu Romero</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td></tr>
          <tr><td>Mc Ardel Cachicho</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td></tr>
          <tr><td>Rocky Fowaya</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td></tr>
          <tr class="total"><td><strong>Total Baguio</strong></td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td></tr>
        </tbody>
      </table>
    </div>
  </section>
<!-- üî• Firebase SDK (Compat Version 11.x) -->
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore-compat.js"></script>

<script>
/* ------------------------------------------------------------
   üî• Firebase Initialization + Live Sync (KM6 Dashboard)
   ------------------------------------------------------------ */
(function initFirebase() {
  if (!window.firebase) {
    console.error("‚ùå Firebase SDK not found!");
    return;
  }

  const firebaseConfig = {
    apiKey: "AIzaSyCStpCWdRO770N4SpH3GKYwp9pg1kP6_O4",
    authDomain: "km6-dashboard.firebaseapp.com",
    projectId: "km6-dashboard",
    storageBucket: "km6-dashboard.appspot.com",
    messagingSenderId: "309068846407",
    appId: "1:309068846407:web:68d51a21f6ab238fa1a862",
  };

  // ‚úÖ Initialize Firebase safely once
  if (firebase.apps.length === 0) firebase.initializeApp(firebaseConfig);
  window.db = firebase.firestore();
  console.log("üî• Firebase initialized successfully.");

  // ------------------------------------------------------------
  // üîÅ Real-Time Sync (PC ‚Üî Mobile)
  // ------------------------------------------------------------
  try {
    const docRef = db.collection("km6_dashboard_data").doc("dashboardTotals");
    docRef.onSnapshot((doc) => {
      if (!doc.exists) {
        console.warn("‚ö†Ô∏è No dashboardTotals document found.");
        return;
      }

      const data = doc.data();
      console.log("üì° Live Firebase update received:", data);

      // ‚úÖ Map Firestore fields ‚Üí localStorage
      if (data.latestData)
        localStorage.setItem("dataweb", JSON.stringify(data.latestData));

      if (data.latest_data)
        localStorage.setItem("pnetinv", JSON.stringify(data.latest_data));

      if (data.invoiceDate)
        localStorage.setItem("invoicedate", JSON.stringify(data.invoiceDate));

      if (data.fsTotals)
        localStorage.setItem("fsTotals", JSON.stringify(data.fsTotals));

      if (data.targets)
        localStorage.setItem("targets", JSON.stringify(data.targets));

      console.log("üíæ LocalStorage synced with Firestore successfully.");

      // ‚úÖ Update timestamp in header
      const updated = data.updated || new Date().toLocaleString();
      const el = document.getElementById("lastUpdated");
      if (el) el.textContent = "Last updated: " + updated;

      // ‚úÖ Re-render dashboard instantly
      if (typeof recomputeAndRenderAll === "function") {
        recomputeAndRenderAll();
      }
    });

    console.log("‚úÖ Live Firebase sync listener ready.");
  } catch (err) {
    console.error("‚ùå Firestore sync setup error:", err);
  }
})();

/* ------------------------------------------------------------
   üì≤ One-Time Restore (Mobile First Load)
   ------------------------------------------------------------ */
async function restoreDashboardFromCloud() {
  try {
    console.log("üì• Fetching dashboard data from Firestore...");
    const docRef = db.collection("km6_dashboard_data").doc("dashboardTotals");
    const snapshot = await docRef.get();

    if (!snapshot.exists) {
      console.warn("‚ö†Ô∏è No dashboardTotals found in Firestore.");
      return;
    }

    const data = snapshot.data();
    console.log("‚úÖ Dashboard data retrieved:", data);

    // ‚úÖ Map Firestore ‚Üí localStorage
    if (data.latestData)
      localStorage.setItem("dataweb", JSON.stringify(data.latestData));
    if (data.latest_data)
      localStorage.setItem("pnetinv", JSON.stringify(data.latest_data));
    if (data.invoiceDate)
      localStorage.setItem("invoicedate", JSON.stringify(data.invoiceDate));
    if (data.fsTotals)
      localStorage.setItem("fsTotals", JSON.stringify(data.fsTotals));
    if (data.targets)
      localStorage.setItem("targets", JSON.stringify(data.targets));

    console.log("üíæ Data restored locally.");

    // ‚úÖ Update timestamp label
    const lastUpdated = document.getElementById("lastUpdated");
    if (lastUpdated)
      lastUpdated.textContent =
        "Last updated: " + (data.updated || new Date().toLocaleString());

    // ‚úÖ Recompute and render everything
    if (typeof recomputeAndRenderAll === "function") {
      recomputeAndRenderAll();
    }

    console.log("üéØ Dashboard fully restored & rendered!");
  } catch (err) {
    console.error("‚ùå Error restoring data from Firestore:", err);
  }
}

/* ------------------------------------------------------------
   üü¢ Force Cloud Restore on Page Load (for Mobile)
   ------------------------------------------------------------ */
window.addEventListener("load", async () => {
  const hasData =
    localStorage.getItem("dataweb") &&
    localStorage.getItem("pnetinv") &&
    localStorage.getItem("invoicedate");

  if (!hasData) {
    console.log("üì± No local data found ‚Äî restoring from Firestore...");
    await restoreDashboardFromCloud();
  } else {
    console.log("üíæ Using cached data ‚Äî waiting for live sync...");
  }

  // Always render once (for speed)
  if (typeof recomputeAndRenderAll === "function") {
    await recomputeAndRenderAll();
  }
});


/* ------------------------------------------------------------
   üß∞ Small Utilities
   ------------------------------------------------------------ */
const fmt = n =>
  Number(n || 0).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });

const num = v => {
  if (v == null || v === "") return 0;
  const cleaned = String(v).replace(/[‚Ç±,()\s]/g, "").replace(/[^\d.-]/g, "").trim();
  const val = parseFloat(cleaned);
  return isNaN(val) ? 0 : val;
};

const normalizeText = s =>
  String(s || "").toUpperCase().replace(/\s+/g, " ").replace(/\u00A0/g, " ").trim();

const setText = (id, val, options = { asNumber: true }) => {
  const el = document.getElementById(id);
  if (!el) return;
  if (options.asNumber) {
    el.textContent = Number(val || 0).toLocaleString(undefined, {
      minimumFractionDigits: 2,
      maximumFractionDigits: 2,
    });
  } else {
    el.textContent = val ?? "";
  }
};

/* ------------------------------------------------------------
   üîî Menu + Logout (guards if elements are missing)
   ------------------------------------------------------------ */
(function wireMenu() {
  const menuIcon = document.querySelector(".menu-icon");
  const dropdownMenu = document.getElementById("dropdownMenu");
  const logoutLink = document.getElementById("logoutLink");

  if (menuIcon && dropdownMenu) {
    menuIcon.addEventListener("click", () => {
      dropdownMenu.style.display = dropdownMenu.style.display === "block" ? "none" : "block";
    });
    window.addEventListener("click", e => {
      if (!e.target.closest(".menu-container")) dropdownMenu.style.display = "none";
    });
  }
  if (logoutLink) {
    logoutLink.addEventListener("click", e => {
      e.preventDefault();
      window.location.href = "https://chadd-cod07.github.io/km6-login/";
    });
  }
})();

/* ------------------------------------------------------------
   üìÖ KPI Date (Selling Days, Progress)
   ------------------------------------------------------------ */
(function updateKPIs() {
  const now = new Date();
  const summaryDate = document.querySelector(".summary .date");
  if (summaryDate) {
    summaryDate.textContent = now.toLocaleDateString(undefined, {
      weekday: "short",
      month: "short",
      day: "numeric",
      year: "numeric",
    });
  }
  const sellingDays = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();
  const actual = now.getDate();
  setText("sellingDays", sellingDays, { asNumber: false });
  setText("actualDays", actual, { asNumber: false });
  setText("progressPct", Math.round((actual / sellingDays) * 100) + "%", { asNumber: false });
  setText("remainingDays", sellingDays - actual, { asNumber: false });
})();

/* ------------------------------------------------------------
   üïò Wait for Uploads (localStorage data to appear)
   - Resolves early if keys already exist
   ------------------------------------------------------------ */
async function waitForUploads({ keys = ["dataweb", "pnetinv", "invoicedate"], timeoutMs = 2500, pollMs = 150 } = {}) {
  const hasAll = () => keys.every(k => !!localStorage.getItem(k));
  if (hasAll()) return;

  const started = Date.now();
  while (Date.now() - started < timeoutMs) {
    if (hasAll()) return;
    await new Promise(r => setTimeout(r, pollMs));
  }
}

// -----------------------------------------------------------
// üì≤ AUTO RESTORE DASHBOARD DATA FROM FIREBASE (FOR MOBILE)
// -----------------------------------------------------------
async function restoreDashboardFromCloud() {
  try {
    console.log("üì° Checking Firestore for saved dashboard data...");
    const docRef = db.collection("km6_dashboard_data").doc("dashboardTotals");
    const snapshot = await docRef.get();

    if (!snapshot.exists) {
      console.warn("‚ö†Ô∏è No dashboardTotals document found in Firestore.");
      return;
    }

    const data = snapshot.data();
    console.log("‚úÖ Dashboard data found in Firestore:", data);

    // ‚úÖ Restore all major datasets to localStorage
    if (data.dataweb) localStorage.setItem("dataweb", JSON.stringify(data.dataweb));
    if (data.pnetinv) localStorage.setItem("pnetinv", JSON.stringify(data.pnetinv));
    if (data.invoicedate) localStorage.setItem("invoicedate", JSON.stringify(data.invoicedate));
    if (data.fsTotals) localStorage.setItem("fsTotals", JSON.stringify(data.fsTotals));
    if (data.overall) localStorage.setItem("overall", JSON.stringify(data.overall));

    console.log("üíæ Data restored to localStorage from Firebase.");

    // ‚úÖ Re-render everything (functions only if they exist)
    if (typeof renderDailySales === "function") renderDailySales();
    if (typeof computeBranchSummary === "function") computeBranchSummary();
    if (typeof renderFSTables === "function") renderFSTables();
    if (typeof autoSumTotals === "function") autoSumTotals();
    if (typeof updateBranchTargets === "function") updateBranchTargets();
    if (typeof updateBranchSummaryCalculations === "function") updateBranchSummaryCalculations();

    // ‚úÖ Update timestamp label
    const lastUpdated = document.getElementById("lastUpdated");
    if (lastUpdated)
      lastUpdated.textContent =
        "Last updated: " + (data.updated || new Date().toLocaleString());

    console.log("üéØ Dashboard fully restored and refreshed!");
  } catch (err) {
    console.error("‚ùå Error restoring data from Firebase:", err);
  }
}

// -----------------------------------------------------------
// üü¢ Auto-Restore from Firebase if no local data (Mobile First Load)
// -----------------------------------------------------------
window.addEventListener("load", async () => {
  const hasData =
    localStorage.getItem("dataweb") &&
    localStorage.getItem("pnetinv") &&
    localStorage.getItem("invoicedate");

  if (!hasData) {
    console.log("üì± No local data found ‚Äî restoring from Firebase...");
    await restoreDashboardFromCloud();
  } else {
    console.log("üíæ Using cached dashboard data ‚Äî waiting for live updates...");
  }

  // Always render at least once
  await recomputeAndRenderAll();
});


/* ------------------------------------------------------------
   üßÆ FS Totals (stable SUM version)
   - Builds fsTotals from dataweb + pnetinv
   ------------------------------------------------------------ */
function computeFSTotals() {
  const dataweb = JSON.parse(localStorage.getItem("dataweb") || "[]");
  const pnetinv = JSON.parse(localStorage.getItem("pnetinv") || "[]");

  if (!Array.isArray(dataweb) || !Array.isArray(pnetinv)) {
    console.warn("‚ö†Ô∏è Missing dataweb or pnetinv in localStorage.");
    return;
  }

  const fsTotals = {};
  const cleanFS = s => normalizeText(s);

  // GROSS per FS (from dataweb)
  dataweb.forEach(row => {
    const fs = cleanFS(row["FS"]);
    const gross = num(row["Sum of Order Amount"]);
    if (!fs) return;
    if (!fsTotals[fs]) fsTotals[fs] = { gross: 0, reject: 0, bo: 0, net: 0 };
    fsTotals[fs].gross += gross;
  });

  // REJECTION, BO, NET per FS (from pnetinv)
  pnetinv.forEach(row => {
    const fs = cleanFS(row["FS"]);
    if (!fs) return;
    const rej = num(row["TOTAL REJECTION"]);
    const bo = num(row["TOTAL BO"] || row["TOTAL B.O."]);
    const netv = num(row["TOTAL NET"]);
    if (!fsTotals[fs]) fsTotals[fs] = { gross: 0, reject: 0, bo: 0, net: 0 };
    fsTotals[fs].reject += rej;
    fsTotals[fs].bo += bo;
    fsTotals[fs].net += netv;
  });

  localStorage.setItem("fsTotals", JSON.stringify(fsTotals));
  console.log("‚úÖ FS totals computed:", fsTotals);
}

/* ------------------------------------------------------------
   üßæ Render FS Tables (KCM / LU / BG) + Targets
   ------------------------------------------------------------ */
function renderFSTables() {
  const fsTotals = JSON.parse(localStorage.getItem("fsTotals") || "{}");

  const groups = {
    KCM: ["Jim Russel Peralta", "Judy Ann Mabanta", "Gilbert Aquino", "Roderick Dacay", "Gyver Gano"],
    LU:  ["Gemma Jacaban", "Jovelyn Castro"],
    BG:  ["Jehu Romero", "Mc Ardel Cachicho", "Rocky Fowaya"]
  };
  const tableIds = { KCM: "tblKCM", LU: "tblLU", BG: "tblBG" };

  const storedTargets = JSON.parse(localStorage.getItem("targets") || "{}");
  const fsTargets = storedTargets.fs || {};

  const fmtPct = v => v.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });

  for (const [group, names] of Object.entries(groups)) {
    const tbody = document.querySelector(`#${tableIds[group]}`);
    if (!tbody) continue;

    const totalRow = tbody.querySelector(".total");
    tbody.innerHTML = "";
    if (totalRow) tbody.appendChild(totalRow);

    const sum = { gross: 0, reject: 0, bo: 0, net: 0, target: 0, balance: 0 };

    names.forEach(name => {
      const fsKey = normalizeText(name);
      const matchedKey = Object.keys(fsTotals).find(k => normalizeText(k) === fsKey) || null;
      const d = matchedKey ? fsTotals[matchedKey] : {};

      const g = num(d?.gross);
      const r = num(d?.reject);
      const b = num(d?.bo);
      const n = num(d?.net);

      // Target match (exact normalized key)
      const tMatch = Object.keys(fsTargets).find(k => normalizeText(k) === fsKey);
      const target = tMatch ? Number(fsTargets[tMatch]) || 0 : 0;

      const pct = target > 0 ? (n / target) * 100 : 0;
      const balance = n - target;

      sum.gross += g; sum.reject += r; sum.bo += b; sum.net += n; sum.target += target; sum.balance += balance;

      const fmtVal = (v, isPct = false) => {
        if (isPct) return fmtPct(v);
        const abs = Math.abs(v).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        return v < 0 ? `(${abs})` : abs;
      };

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${name}</td>
        <td>${fmtVal(g)}</td>
        <td>${fmtVal(r)}</td>
        <td>${fmtVal(b)}</td>
        <td>${fmtVal(n)}</td>
        <td>${fmtVal(target)}</td>
        <td>${fmtVal(pct, true)}%</td>
        <td>${fmtVal(balance)}</td>
      `;
      tbody.insertBefore(tr, totalRow);
    });

    const totalPct = sum.target > 0 ? (sum.net / sum.target) * 100 : 0;
    const fmtBalance = sum.balance < 0
      ? `(${Math.abs(sum.balance).toLocaleString(undefined, { minimumFractionDigits: 2 })})`
      : sum.balance.toLocaleString(undefined, { minimumFractionDigits: 2 });

    if (totalRow) {
      totalRow.innerHTML = `
        <td><b>Total ${group}</b></td>
        <td><b>${fmt(sum.gross)}</b></td>
        <td><b>${fmt(sum.reject)}</b></td>
        <td><b>${fmt(sum.bo)}</b></td>
        <td><b>${fmt(sum.net)}</b></td>
        <td><b>${fmt(sum.target)}</b></td>
        <td><b>${fmt(totalPct)}%</b></td>
        <td><b>${fmtBalance}</b></td>
      `;
      totalRow.style.backgroundColor = "#fff8cc";
    }
  }
}

/* ------------------------------------------------------------
   üè¢ Branch Summary (Baguio / La Union) ‚Äî merged version
   ------------------------------------------------------------ */
function computeBranchSummary() {
  const dataweb = JSON.parse(localStorage.getItem("dataweb") || "[]");
  const pnetinv = JSON.parse(localStorage.getItem("pnetinv") || "[]");

  const branches = {
    BAGUIO:   { gross: 0, reject: 0, bo: 0, net: 0 },
    "LA UNION": { gross: 0, reject: 0, bo: 0, net: 0 }
  };

  // From dataweb (Gross)
  dataweb.forEach(r => {
    const rec = {};
    for (const [k, v] of Object.entries(r)) rec[normalizeText(k)] = v;
    const branch = normalizeText(rec["BRANCH NAME"]);
    const gross = num(rec["SUM OF ORDER AMOUNT"]);
    if (branch.includes("KM6") || branch.includes("BAGUIO")) branches.BAGUIO.gross += gross;
    if (branch.includes("KML") || branch.includes("LA UNION")) branches["LA UNION"].gross += gross;
  });

  // From pnetinv (Reject / BO / Net)
  pnetinv.forEach(r => {
    const rec = {};
    for (const [k, v] of Object.entries(r)) rec[normalizeText(k)] = v;
    const branch = normalizeText(rec["BRANCH NAME"]);
    const rej = num(rec["TOTAL REJECTION"]);
    const bo = num(rec["TOTAL BO"]) || num(rec["TOTAL B.O."]);
    const netv = num(rec["TOTAL NET"]);
    if (branch.includes("KM6") || branch.includes("BAGUIO")) {
      branches.BAGUIO.reject += rej; branches.BAGUIO.bo += bo; branches.BAGUIO.net += netv;
    }
    if (branch.includes("KML") || branch.includes("LA UNION")) {
      branches["LA UNION"].reject += rej; branches["LA UNION"].bo += bo; branches["LA UNION"].net += netv;
    }
  });

  // Display individual branches
  setText("km6Gross",  branches.BAGUIO.gross);
  setText("km6Reject", branches.BAGUIO.reject);
  setText("km6BO",     branches.BAGUIO.bo);
  setText("km6Net",    branches.BAGUIO.net);

  setText("kmlGross",  branches["LA UNION"].gross);
  setText("kmlReject", branches["LA UNION"].reject);
  setText("kmlBO",     branches["LA UNION"].bo);
  setText("kmlNet",    branches["LA UNION"].net);

  // Totals for "Total KM6" row
  const totalGross  = branches.BAGUIO.gross + branches["LA UNION"].gross;
  const totalReject = branches.BAGUIO.reject + branches["LA UNION"].reject;
  const totalBO     = branches.BAGUIO.bo     + branches["LA UNION"].bo;
  const totalNet    = branches.BAGUIO.net    + branches["LA UNION"].net;

  setText("totGross",  totalGross);
  setText("totReject", totalReject);
  setText("totBO",     totalBO);
  setText("totNet",    totalNet);

  console.log("üè¢ Branch summary (Baguio + La Union):", branches);
}

/* ------------------------------------------------------------
   üßÆ Unified AutoSum (Branch table)
   - Uses the visible table; falls back to IDs if needed
   ------------------------------------------------------------ */
function autoSumTotals() {
  // Table-based (preferred)
  const table = document.querySelector(".table-container table");
  if (table) {
    const rows = table.querySelectorAll("tbody tr");
    let totalGross = 0, totalReject = 0, totalBO = 0, totalNet = 0;

    rows.forEach(row => {
      const cells = row.querySelectorAll("td");
      if (!cells.length) return;
      const branchName = (cells[0]?.innerText || "").trim();
      if (branchName.toLowerCase().includes("total km6")) return;

      totalGross  += Number((cells[1]?.innerText || "0").replace(/,/g, "")) || 0;
      totalReject += Number((cells[2]?.innerText || "0").replace(/,/g, "")) || 0;
      totalBO     += Number((cells[3]?.innerText || "0").replace(/,/g, "")) || 0;
      totalNet    += Number((cells[4]?.innerText || "0").replace(/,/g, "")) || 0;
    });

    const totalRow = Array.from(rows).find(row =>
      row.querySelector("td")?.innerText.trim().toLowerCase().includes("total km6")
    );

    if (totalRow) {
      const tds = totalRow.querySelectorAll("td");
      if (tds[1]) tds[1].innerText = totalGross.toLocaleString(undefined, { minimumFractionDigits: 2 });
      if (tds[2]) tds[2].innerText = totalReject.toLocaleString(undefined, { minimumFractionDigits: 2 });
      if (tds[3]) tds[3].innerText = totalBO.toLocaleString(undefined, { minimumFractionDigits: 2 });
      if (tds[4]) tds[4].innerText = totalNet.toLocaleString(undefined, { minimumFractionDigits: 2 });
    }

    console.log("üìä AutoSum (table):", { totalGross, totalReject, totalBO, totalNet });
    return;
  }

  // Fallback to ID-based (if no table found)
  const getNumber = id => {
    const el = document.getElementById(id);
    return el ? parseFloat(el.textContent.replace(/,/g, "")) || 0 : 0;
  };
  const setNumber = (id, value) => {
    const el = document.getElementById(id);
    if (el)
      el.textContent = value.toLocaleString(undefined, {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2,
      });
  };

  const totalGross  = getNumber("km6Gross") + getNumber("kmlGross");
  const totalReject = getNumber("km6Reject") + getNumber("kmlReject");
  const totalBO     = getNumber("km6BO")    + getNumber("kmlBO");
  const totalNet    = getNumber("km6Net")   + getNumber("kmlNet");

  setNumber("totGross",  totalGross);
  setNumber("totReject", totalReject);
  setNumber("totBO",     totalBO);
  setNumber("totNet",    totalNet);

  console.log("üìä AutoSum (IDs):", { totalGross, totalReject, totalBO, totalNet });
}

/* ------------------------------------------------------------
   üéØ FS Targets ‚Äî table cell filler (from targets.fs)
   ------------------------------------------------------------ */
function updateFSTargets() {
  const targets = JSON.parse(localStorage.getItem("targets") || "{}");
  const fs = targets.fs || {};
  if (!Object.keys(fs).length) {
    console.warn("‚ö†Ô∏è No FS target data found in localStorage.targets.fs");
    return;
  }
  document.querySelectorAll("table tbody tr").forEach(row => {
    const fsName = row.cells?.[0]?.textContent?.trim();
    const targetCell = row.cells?.[5]; // TARGET column (6th)
    if (!fsName || !targetCell) return;
    const matchKey = Object.keys(fs).find(k => normalizeText(k) === normalizeText(fsName));
    const targetVal = matchKey ? Number(fs[matchKey]) || 0 : 0;
    targetCell.textContent = targetVal.toLocaleString(undefined, {
      minimumFractionDigits: 2,
      maximumFractionDigits: 2,
    });
  });
  console.log("üéØ FS Targets updated successfully from localStorage.targets.fs");
}

/* ------------------------------------------------------------
   üè¢ Branch Targets (% and Balance computations)
   ------------------------------------------------------------ */
function updateBranchTargets() {
  const targetData = JSON.parse(localStorage.getItem("targets") || "{}");
  if (!targetData.branches) {
    console.warn("‚ö†Ô∏è No branch-level target data found.");
    return;
  }

  // Normalize and convert to numbers safely
  const bData = targetData.branches;
  const km6Val = Number(bData.KM6 || bData.BAGUIO || 0);
  const kmlVal = Number(bData.KML || bData["LA UNION"] || 0);
  const totalVal = km6Val + kmlVal;

  // Force update with formatted output
  setText("km6Target", km6Val.toFixed(2), { asNumber: true });
  setText("kmlTarget", kmlVal.toFixed(2), { asNumber: true });
  setText("totTarget", totalVal.toFixed(2), { asNumber: true });

  console.log("üè¢ Branch Targets:", { Baguio: km6Val, "La Union": kmlVal, Total: totalVal });
}

function updateBranchSummaryCalculations() {
  const rows = [
    { netId: "km6Net", targetId: "km6Target", pctId: "km6Pct", balId: "km6Bal" },
    { netId: "kmlNet", targetId: "kmlTarget", pctId: "kmlPct", balId: "kmlBal" }
  ];
  let totalNet = 0, totalTarget = 0, totalBal = 0;

  rows.forEach(row => {
    const net = parseFloat((document.getElementById(row.netId)?.innerText || "0").replace(/,/g, "")) || 0;
    const tar = parseFloat((document.getElementById(row.targetId)?.innerText || "0").replace(/,/g, "")) || 0;
    const pct = tar > 0 ? (net / tar) * 100 : 0;
    const bal = net - tar;

    const pctText = pct.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + "%";
    const balText = bal < 0
      ? `(${Math.abs(bal).toLocaleString(undefined, { minimumFractionDigits: 2 })})`
      : bal.toLocaleString(undefined, { minimumFractionDigits: 2 });

    const pctEl = document.getElementById(row.pctId);
    const balEl = document.getElementById(row.balId);
    if (pctEl) pctEl.innerText = pctText;
    if (balEl) balEl.innerText = balText;

    totalNet += net; totalTarget += tar; totalBal += bal;
  });

  const totPct = totalTarget > 0 ? (totalNet / totalTarget) * 100 : 0;
  const totBalText = totalBal < 0
    ? `(${Math.abs(totalBal).toLocaleString(undefined, { minimumFractionDigits: 2 })})`
    : totalBal.toLocaleString(undefined, { minimumFractionDigits: 2 });

  const totPctEl = document.getElementById("totPct");
  const totBalEl = document.getElementById("totBal");
  if (totPctEl) totPctEl.innerText = totPct.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + "%";
  if (totBalEl) totBalEl.innerText = totBalText;

  console.log("üìä Branch Summary % and Balance updated.");
}

/* ------------------------------------------------------------
   üìò Daily Sales (from 'Invoice date' sheet)
   ------------------------------------------------------------ */
function computeDailySales(invoiceData) {
  if (!invoiceData || !invoiceData.length) return null;

  invoiceData = invoiceData.map(r => {
    const obj = {};
    for (const [k, v] of Object.entries(r)) obj[normalizeText(k)] = v;
    return obj;
  });

  const valid = invoiceData.filter(r => r["INVOICE DATE"] && (r["KM6"] || r["KML"] || r["TOTAL"]));
  if (valid.length < 2) return null;

  const prev = valid[valid.length - 2];
  const curr = valid[valid.length - 1];

  const toNum = v => parseFloat(String(v || "0").replace(/[^0-9.-]/g, "")) || 0;
  const changePct = (c, p) => {
  const total = c + p;
  if (total === 0) return 0;
  const prevShare = (p / total) * 100;
  const currShare = (c / total) * 100;
  return currShare - prevShare; // difference in percentage points
};

  return {
    KM6:  { prev: toNum(prev["KM6"]),  curr: toNum(curr["KM6"]),  change: changePct(toNum(curr["KM6"]),  toNum(prev["KM6"]))  },
    KML:  { prev: toNum(prev["KML"]),  curr: toNum(curr["KML"]),  change: changePct(toNum(curr["KML"]),  toNum(prev["KML"]))  },
    Total:{ prev: toNum(prev["TOTAL"]),curr: toNum(curr["TOTAL"]),change: changePct(toNum(curr["TOTAL"]),toNum(prev["TOTAL"])) }
  };
}

function renderDailySales() {
  const invoiceData =
    JSON.parse(localStorage.getItem("invoicedate") || "[]") ||
    JSON.parse(localStorage.getItem("invoiceDateData") || "[]") ||
    [];

  if (!invoiceData.length) {
    console.warn("‚ö†Ô∏è No 'Invoice date' data found in localStorage.");
    return;
  }

  const daily = computeDailySales(invoiceData);
  if (!daily) return;

  const peso = n => "‚Ç±" + Number(n).toLocaleString("en-PH", { minimumFractionDigits: 2 });
  const arrow = pct => {
  const formatted = `${Math.abs(pct).toFixed(2)}%`;
  if (pct > 0)
    return `<span style="color:green; font-weight:700;">‚ñ≤ ${formatted}</span>`;
  if (pct < 0)
    return `<span style="color:red; font-weight:700;">‚ñº ${formatted}</span>`;
  return `<span style="color:gray; font-weight:700;">${formatted}</span>`;
};

  // Cards: Total (prev/curr/change)
  const prevKM6 = document.getElementById("prevKM6");
  const currKM6 = document.getElementById("currKM6");
  const changeKM6 = document.getElementById("changeKM6");
  if (prevKM6)  prevKM6.textContent = peso(daily.Total.prev);
  if (currKM6)  currKM6.textContent = peso(daily.Total.curr);
  if (changeKM6) changeKM6.innerHTML = arrow(daily.Total.change);

  // Baguio (KM6)
  const prevB = document.getElementById("prevBaguio");
  const currB = document.getElementById("currBaguio");
  const chgB  = document.getElementById("changeBaguio");
  if (prevB) prevB.textContent = peso(daily.KM6.prev);
  if (currB) currB.textContent = peso(daily.KM6.curr);
  if (chgB)  chgB.innerHTML = arrow(daily.KM6.change);

  // La Union (KML)
  const prevL = document.getElementById("prevLU");
  const currL = document.getElementById("currLU");
  const chgL  = document.getElementById("changeLU");
  if (prevL) prevL.textContent = peso(daily.KML.prev);
  if (currL) currL.textContent = peso(daily.KML.curr);
  if (chgL)  chgL.innerHTML = arrow(daily.KML.change);

  console.log("‚úÖ Daily Sales Updated:", daily);
}

/* ------------------------------------------------------------
   üöÄ Main Compute (Multi-branch) ‚Äî includes targets integration
   ------------------------------------------------------------ */
async function computeKM6Dashboard() {
  await waitForUploads();

  // Header normalization if needed
  function fixData(raw) {
    if (!raw) return [];
    if (Array.isArray(raw) && Array.isArray(raw[0])) {
      const headers = raw[0].map(h => String(h || "").trim());
      return raw.slice(1).map(r => Object.fromEntries(headers.map((h, i) => [h, r[i]])));
    }
    return raw;
  }

  let dataweb = fixData(JSON.parse(localStorage.getItem("dataweb") || "[]"));
  let pnetinv = fixData(JSON.parse(localStorage.getItem("pnetinv") || "[]"));
  let invoicedate = fixData(JSON.parse(localStorage.getItem("invoicedate") || "[]"));
  const targets = JSON.parse(localStorage.getItem("targets") || "{}");

  if (!dataweb.length && !pnetinv.length) {
    console.warn("‚ö†Ô∏è No uploaded Excel data found.");
    return;
  }

  const branches = ["KM6", "KML", "BAGUIO", "KCM"];
  const totals = {};

  branches.forEach(branch => {
    const gross = dataweb
      .filter(r => normalizeText(r["Branch Name"]) === normalizeText(branch))
      .reduce((sum, r) => sum + num(r["Sum of Order Amount"]), 0);

    const net = pnetinv
      .filter(r => normalizeText(r["Branch Name"]) === normalizeText(branch))
      .reduce((sum, r) => sum + num(r["TOTAL NET"]), 0);

    const rej = pnetinv
      .filter(r => normalizeText(r["Branch Name"]) === normalizeText(branch))
      .reduce((sum, r) => sum + num(r["TOTAL REJECTION"]), 0);

    const bo = pnetinv
      .filter(r => normalizeText(r["Branch Name"]) === normalizeText(branch))
      .reduce((sum, r) => sum + num(r["TOTAL BO"] || r["TOTAL B.O."]), 0);

    totals[branch] = { gross, net, reject: rej, bo, target: 0 };
  });

  // Integrate branch-level targets if present
  if (targets && typeof targets === "object") {
    branches.forEach(branch => {
      const branchTarget = targets[branch] || targets[branch.toUpperCase()] || targets[branch.toLowerCase()] || 0;
      totals[branch].target = num(branchTarget);
    });
  }

  // Display (by IDs if present)
  const show = (id, val) => setText(id, val);
  let totalAll = { gross: 0, net: 0, reject: 0, bo: 0, target: 0 };

  branches.forEach(branch => {
    const t = totals[branch];
    totalAll.gross += t.gross; totalAll.net += t.net; totalAll.reject += t.reject; totalAll.bo += t.bo; totalAll.target += t.target;

    show(`${branch}_gross`, t.gross);
    show(`${branch}_net`,   t.net);
    show(`${branch}_reject`,t.reject);
    show(`${branch}_bo`,    t.bo);
    show(`${branch}_target`,t.target);

    const elPct = document.getElementById(`${branch}_pct`);
    if (elPct) elPct.textContent = t.target ? ((t.net / t.target) * 100).toFixed(2) + "%" : "-";
  });

  show("totGross",  totalAll.gross);
  show("totNet",    totalAll.net);
  show("totReject", totalAll.reject);
  show("totBO",     totalAll.bo);
  const totPctEl = document.getElementById("totPct");
  if (totPctEl) totPctEl.textContent = totalAll.target ? ((totalAll.net / totalAll.target) * 100).toFixed(2) + "%" : "-";

  // Daily comparison (Invoice date last 2 rows)
  if (invoicedate.length > 1) {
    const last = invoicedate[invoicedate.length - 1];
    const prev = invoicedate[invoicedate.length - 2];
    const km6Curr = num(last["KM6"]) + num(last["KML"]);
    const km6Prev = num(prev["KM6"]) + num(prev["KML"]);
    const pct = km6Prev ? ((km6Curr - km6Prev) / km6Prev) * 100 : 0;

    const upd = (idPrev, idCurr, idChange, prevVal, currVal) => {
      setText(idPrev, prevVal);
      setText(idCurr, currVal);
      const elCh = document.getElementById(idChange);
      if (elCh) {
        elCh.textContent = (pct >= 0 ? "‚ñ≤ " : "‚ñº ") + Math.abs(pct).toFixed(2) + "%";
        elCh.className = pct >= 0 ? "up" : "down";
      }
    };
    upd("prevKM6", "currKM6", "changeKM6", km6Prev, km6Curr);
  }
}

/* ------------------------------------------------------------
   üßÆ FS Target Column Totals (per FS table)
   ------------------------------------------------------------ */
function autoSumFSTargetTotals() {
  ["tblKCM", "tblLU", "tblBG"].forEach(tblId => {
    const tbody = document.getElementById(tblId);
    if (!tbody) return;
    const rows = tbody.querySelectorAll("tr:not(.total)");
    const totalRow = tbody.querySelector("tr.total");
    if (!totalRow) return;

    let totalTarget = 0;
    rows.forEach(row => {
      const cells = row.querySelectorAll("td");
      if (cells.length < 6) return;
      const val = Number(cells[5].innerText.replace(/,/g, "")) || 0;
      totalTarget += val;
    });

    const totalCells = totalRow.querySelectorAll("td");
    if (totalCells.length >= 6) {
      totalCells[5].innerText = totalTarget.toLocaleString(undefined, { minimumFractionDigits: 2 });
    }
  });
  console.log("üßÆ Auto-summed total Targets per FS table.");
}

/* ------------------------------------------------------------
   üîÅ Recompute + Render (single orchestrator)
   ------------------------------------------------------------ */
async function recomputeAndRenderAll() {
  // Ensure fsTotals exist
  let fsData = JSON.parse(localStorage.getItem("fsTotals") || "{}");
  if (!Object.keys(fsData).length) {
    computeFSTotals();
    fsData = JSON.parse(localStorage.getItem("fsTotals") || "{}");
  }

  // Main computations in order
  await computeKM6Dashboard();
  computeBranchSummary();
  renderFSTables();

  // Targets + percents/balances
  updateFSTargets();
  autoSumFSTargetTotals();
  updateBranchTargets();
  updateBranchSummaryCalculations();

  // Branch totals recalculated from rendered rows (and/or ID fallback)
  autoSumTotals();

  // Daily sales cards
  renderDailySales();
}

/* ------------------------------------------------------------
   üîÑ Storage Change Listener (single, merged)
   ------------------------------------------------------------ */
window.addEventListener("storage", (event) => {
  const keys = ["dataweb", "pnetinv", "invoicedate", "invoiceDateData", "targets", "fsTotals"];
  if (!keys.includes(event.key)) return;

  console.log("üîÑ Detected data update from another tab/page:", event.key);
  (async () => {
    await recomputeAndRenderAll();
  })().catch(console.error);
});

/* ------------------------------------------------------------
   üö¶ Boot Sequence
   - Auto-restore from cloud if no local data
   - Then compute & render everything
   ------------------------------------------------------------ */
window.addEventListener("DOMContentLoaded", async () => {
  try {
    const hasData =
      localStorage.getItem("dataweb") &&
      localStorage.getItem("pnetinv") &&
      localStorage.getItem("invoicedate");

if (!hasData) {
  console.log("üì• No local data found ‚Äî restoring from Firebase...");
  await restoreDashboardFromCloud(); // first-time load
} else {
  console.log("üíæ Local data found ‚Äî displaying cached version...");
  setText("lastUpdated", "Last updated: " + new Date().toLocaleString(), { asNumber: false });

  // ‚úÖ Force background refresh from Firestore
  console.log("‚òÅÔ∏è Checking Firebase for updated data...");
  try {
    await restoreDashboardFromCloud(); // force re-sync even if local data exists
    console.log("‚úÖ Cloud refresh complete ‚Äî data now up to date.");
  } catch (err) {
    console.warn("‚ö†Ô∏è Cloud refresh failed (offline mode?)", err);
  }
}


    // üßÆ Recompute & render everything
    await recomputeAndRenderAll();

    // üïí Safety delayed refreshes (in case of slow DOM updates)
setTimeout(() => {
  updateFSTargets();
  autoSumFSTargetTotals();
  updateBranchTargets();
}, 1000);

setTimeout(() => {
  updateBranchSummaryCalculations(); // compute after targets are ready
}, 1200);

    setTimeout(() => { autoSumTotals(); }, 1200);
    setTimeout(() => { renderDailySales(); }, 1500);

  } catch (err) {
    console.error("‚ùå Initialization error:", err);
  }
});

</script>

</body>
</html>