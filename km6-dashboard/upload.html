<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Upload Excel Files - KM6 Dashboard</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore-compat.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f6f8fa;
      text-align: center;
      padding: 40px;
    }
    h2 { color: #00843d; }
    .container { display: flex; flex-wrap: wrap; justify-content: center; gap: 30px; margin-top: 30px; }
    .card {
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      padding: 30px;
      width: 400px;
      text-align: center;
    }
    .card h3 { margin: 0; color: #00843d; }
    .card p { color: #444; }
    input[type=file] {
      padding: 8px;
      border: 2px dashed #00843d;
      border-radius: 10px;
      background: #fff;
      width: 80%;
      margin: 12px auto;
      cursor: pointer;
    }
    button {
      background: #00843d;
      color: #fff;
      border: none;
      padding: 10px 22px;
      border-radius: 6px;
      cursor: pointer;
      margin-top: 10px;
    }
    button:hover { background: #006b32; }
    .status { margin-top: 14px; color: #00843d; font-weight: bold; font-size: 15px; line-height: 1.4; }
    .error { color: red; }
    .back-btn {
      margin-top: 40px;
      background: #333;
      color: #fff;
      padding: 10px 25px;
      border-radius: 8px;
      text-decoration: none;
      display: inline-block;
    }
  </style>
</head>
<body>

  <h2>üìÅ Upload Excel Files to Update Dashboard</h2>
  <p>Select and upload your latest files below:</p>

  <div class="container">
    <!-- Daily Sales Upload -->
    <div class="card">
      <h3>üìä Daily Sales Data</h3>
      <p><b>dataweb.xlsx</b></p>
      <input type="file" id="fileDaily" accept=".xlsx,.xls" />
      <button id="uploadDaily">Upload Daily Data</button>
      <div class="status" id="statusDaily"></div>
    </div>

    <!-- Target Upload -->
    <div class="card">
      <h3>üéØ Monthly Target Data</h3>
      <p><b>Target.xlsx</b></p>
      <input type="file" id="fileTarget" accept=".xlsx,.xls" />
      <button id="uploadTarget">Upload Target Data</button>
      <div class="status" id="statusTarget"></div>
    </div>
  </div>

  <a class="back-btn" href="index.html">‚¨Ö Go Back to Dashboard</a>
<script>
  // --- Firebase Setup ---
  const firebaseConfig = {
    apiKey: "AIzaSyCStpCWdRO770N4SpH3GKYwp9pg1kP6_O4",
    authDomain: "km6-dashboard.firebaseapp.com",
    projectId: "km6-dashboard",
    storageBucket: "km6-dashboard.appspot.com",
    messagingSenderId: "309068846407",
    appId: "1:309068846407:web:68d51a21f6ab238fa1a862"
  };
  if (firebase.apps.length === 0) firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  const fmt = n => Number(n || 0).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
  const num = t => parseFloat(String(t || "").replace(/[^0-9.-]/g, "")) || 0;
  const U = s => String(s || "").trim().toUpperCase();

  // Helper to find sheet by partial name
  function findSheet(wb, name) {
    const key = wb.SheetNames.find(s => s.toLowerCase().includes(name.toLowerCase()));
    return key ? wb.Sheets[key] : null;
  }

  // ================================================================
  // ‚úÖ Upload Daily Sales Data (dataweb.xlsx)
  // ================================================================
  document.getElementById("uploadDaily").addEventListener("click", async () => {
    const file = document.getElementById("fileDaily").files[0];
    const status = document.getElementById("statusDaily");
    if (!file) return alert("Please select dataweb.xlsx first.");

    try {
      const data = await file.arrayBuffer();
      const wb = XLSX.read(data, { type: "array" });

      const grossSheet = findSheet(wb, "gross");
      const netSheet = findSheet(wb, "p_net");
      const invSheet = findSheet(wb, "invoice date") || findSheet(wb, "invoice");

      if (!grossSheet || !netSheet || !invSheet) {
        status.innerHTML = `<span class='error'>‚ùå Missing required sheets (Gross, P_Net.Inv, Invoice Date)</span>`;
        return;
      }

      const grossRows = XLSX.utils.sheet_to_json(grossSheet);
      const netRows = XLSX.utils.sheet_to_json(netSheet);
      const invRows = XLSX.utils.sheet_to_json(invSheet);

      const totals = { KM6: { gross: 0, reject: 0, bo: 0, net: 0 }, KML: { gross: 0, reject: 0, bo: 0, net: 0 } };
      const fsTotals = {};

      // --- Process Gross Sheet ---
      for (const r of grossRows) {
        const record = {};
        for (let [k, v] of Object.entries(r)) record[k.trim().toUpperCase()] = v;
        const branch = U(record["BRANCH NAME"]);
        const fs = U(record["FS"]);
        const val = num(record["SUM OF ORDER AMOUNT"]);
        if (!fs) continue;
        if (!fsTotals[fs]) fsTotals[fs] = { gross: 0, reject: 0, bo: 0, net: 0 };
        fsTotals[fs].gross += val;
        if (branch.includes("KM6") || branch.includes("BAGUIO")) totals.KM6.gross += val;
        if (branch.includes("KML") || branch.includes("LA UNION")) totals.KML.gross += val;
      }

      // --- Process P_Net.Inv Sheet ---
      for (const r of netRows) {
        const record = {};
        for (let [k, v] of Object.entries(r)) record[k.trim().toUpperCase()] = v;
        const branch = U(record["BRANCH NAME"]);
        const fs = U(record["FS"]);
        const rej = num(record["TOTAL REJECTION"]);
        const bo = num(record["TOTAL BO"]);
        const net = num(record["TOTAL NET"]);
        if (!fs) continue;
        if (!fsTotals[fs]) fsTotals[fs] = { gross: 0, reject: 0, bo: 0, net: 0 };
        fsTotals[fs].reject += rej;
        fsTotals[fs].bo += bo;
        fsTotals[fs].net += net;
        if (branch.includes("KM6") || branch.includes("BAGUIO")) {
          totals.KM6.reject += rej; totals.KM6.bo += bo; totals.KM6.net += net;
        }
        if (branch.includes("KML") || branch.includes("LA UNION")) {
          totals.KML.reject += rej; totals.KML.bo += bo; totals.KML.net += net;
        }
      }

      // --- Process Invoice Date Sheet ---
      let invoiceDate = { current: {}, previous: {} };
      if (invRows.length >= 2) {
        const last = invRows[invRows.length - 1];
        const prev = invRows[invRows.length - 2];
        invoiceDate = {
          current: { KM6: num(last["KM6"]), KML: num(last["KML"]) },
          previous: { KM6: num(prev["KM6"]), KML: num(prev["KML"]) }
        };
      }

      // --- Save to Firebase & Local ---
      await db.collection("km6_dashboard_data").doc("dashboardTotals").set(totals);
      await db.collection("km6_dashboard_data").doc("fsTotals").set(fsTotals);
      await db.collection("km6_dashboard_data").doc("invoiceDate").set(invoiceDate);

      localStorage.setItem("dashboardTotals", JSON.stringify(totals));
      localStorage.setItem("fsTotals", JSON.stringify(fsTotals));
      localStorage.setItem("dataweb", JSON.stringify(grossRows));
      localStorage.setItem("pnetinv", JSON.stringify(netRows));
      localStorage.setItem("invoicedate", JSON.stringify(invRows));

      // --- Display confirmation ---
      status.innerHTML = `‚úÖ Daily data uploaded successfully!<br>Last updated: ${new Date().toLocaleString()}`;
      console.log("üìä Daily data saved:", { totals, fsTotals, invoiceDate });

    } catch (err) {
      console.error("‚ùå Error uploading dataweb:", err);
      status.innerHTML = `<span class="error">Error loading file: ${err.message}</span>`;
    }
  });

// ‚úÖ Upload Monthly Target Data (Target.xlsx)
// ================================================================
document.getElementById("uploadTarget").addEventListener("click", async () => {
  const file = document.getElementById("fileTarget").files[0];
  const status = document.getElementById("statusTarget");
  if (!file) return alert("Please select Target.xlsx first.");

  try {
    const data = await file.arrayBuffer();
    const wb = XLSX.read(data, { type: "array" });
    const sheetName = wb.SheetNames.find(n => n.toLowerCase().includes("target")) || wb.SheetNames[0];
    const sheet = wb.Sheets[sheetName];
    const rows = XLSX.utils.sheet_to_json(sheet, { defval: "" });

    if (!rows.length) {
      status.innerHTML = `<span class="error">‚ùå Target sheet is empty</span>`;
      return;
    }

    const headers = Object.keys(rows[0]);
    const branchKey = headers.find(h => h.toLowerCase().includes("branch")) || "Branch";
    const fsKey = headers.find(h => h.toLowerCase().includes("fs")) || "FS";
    const targetKey = headers.find(h => h.toLowerCase().includes("target")) || "Target Value";

    const branches = {};
    const fsTotals = {};
    const fsTargetData = [];
    let validCount = 0;

    for (const row of rows) {
      let branchRaw = (row[branchKey] || "").toString().trim().toUpperCase();
      let fsRaw = (row[fsKey] || "").toString().trim().toUpperCase();
      let rawVal = row[targetKey];

      // --- Convert target value safely ---
      let val = 0;
      if (typeof rawVal === "number") val = rawVal;
      else if (typeof rawVal === "string") val = parseFloat(rawVal.replace(/[^\d.-]/g, "")) || 0;
      val = Number(val.toFixed(2));
      if ((!branchRaw && !fsRaw) || val <= 0) continue;

      // --- Normalize branch names ---
      if (branchRaw === "KM6") branchRaw = "BAGUIO";
      if (branchRaw === "KML") branchRaw = "LA UNION";

      // --- Clean FS and branch strings ---
      const cleanBranch = branchRaw.replace(/\s+/g, " ").trim();
      const cleanFS = fsRaw.replace(/\s+/g, " ").trim();

      // --- Handle possible missing FS column (common in your Target.xlsx) ---
      // If FS column is blank but branch column looks like a name, use it as FS.
      const isFSRow =
        !cleanBranch.includes("KCM") &&
        !cleanBranch.includes("TERTIARY") &&
        !cleanBranch.includes("TOTAL") &&
        !cleanBranch.includes("GRAND") &&
        !["BAGUIO", "LA UNION", "KM6", "KML"].includes(cleanBranch);

      // --- Assign FS ---
      if (isFSRow && !fsRaw) fsRaw = cleanBranch;

      // --- Save branch totals ---
      if (["BAGUIO", "LA UNION"].includes(cleanBranch)) {
        branches[cleanBranch] = (branches[cleanBranch] || 0) + val;
      }

      // --- Save FS totals ---
      if (fsRaw) {
        const fsName = fsRaw.toUpperCase().trim();
        fsTotals[fsName] = (fsTotals[fsName] || 0) + val;
        fsTargetData.push({ FS: fsName, Target: val });
        validCount++;
      }
    }

    // üßπ Clean duplicates and invalid FS rows
    const uniqueFS = [];
    const seen = new Set();
    for (const item of fsTargetData) {
      if (item.FS && !seen.has(item.FS)) {
        seen.add(item.FS);
        uniqueFS.push(item);
      }
    }

    // ‚úÖ Save all target-related data together
// ‚úÖ Build final, verified target structure (no more fsTargetData)
const targets = {
  branches,
  fs: fsTotals
};

// ‚úÖ Save locally
localStorage.setItem("targets", JSON.stringify(targets));

// ‚úÖ Save to Firestore (for persistence across logins/devices)
await db.collection("km6_dashboard_data").doc("targets").set(targets);

// ‚úÖ Also save latest uploaded datasets (for cross-device sync)
await db.collection("km6_dashboard_data").doc("latest_data").set({
  targets,
  updatedAt: new Date().toISOString(),
});

console.log("‚úÖ Data successfully synced: targets only (clean, accurate data)");
console.log("üéØ Targets saved successfully:", targets);

// üß† For visibility in console
console.table(
  Object.entries(fsTotals).map(([FS, Target]) => ({ FS, Target }))
);

status.innerHTML = `‚úÖ Target sheet loaded (${rows.length} rows, ${validCount} valid FS targets)<br>
  Target uploaded successfully!<br>
  Last updated: ${new Date().toLocaleString()}`;


    status.innerHTML = `‚úÖ Target sheet loaded (${rows.length} rows, ${validCount} valid FS targets)<br>
      Target uploaded successfully!<br>
      Last updated: ${new Date().toLocaleString()}`;

  } catch (err) {
    console.error("‚ùå Error uploading Target.xlsx:", err);
    status.innerHTML = `<span class="error">Error loading file: ${err.message}</span>`;
  }
});

</script>

</body>
</html>
