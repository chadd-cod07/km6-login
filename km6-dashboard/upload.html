<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Upload Excel File - KM6 Dashboard</title>
  <link rel="stylesheet" href="style.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f6f8fa;
      text-align: center;
      padding: 50px;
    }

    h2 {
      color: #00843d;
    }

    input[type="file"] {
      padding: 10px;
      border: 2px dashed #00843d;
      border-radius: 10px;
      background: #fff;
      cursor: pointer;
      margin-top: 20px;
    }

    .result {
      margin-top: 30px;
      background: #fff;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      display: inline-block;
      text-align: left;
      width: 320px;
    }

    button {
      background-color: #00843d;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      margin-top: 20px;
    }

    button:hover {
      background-color: #006f32;
    }
  </style>
</head>
<body>

  <h2>ðŸ“Š Upload Excel File to Update Dashboard</h2>
  <p>Select your latest <strong>dataweb.xlsx</strong> file below:</p>
  <input type="file" id="fileInput" accept=".xlsx, .xls" />

  <div class="result" id="result"></div>

  <button id="backButton" style="display:none;">Go Back to Dashboard</button>
<script>
document.getElementById('fileInput').addEventListener('change', handleFile, false);

document.getElementById('backButton').addEventListener('click', () => {
  // âœ… Redirect depending on environment
  if (window.location.hostname === "127.0.0.1" || window.location.hostname === "localhost") {
    window.location.href = "index.html"; // Local (VS Code Live Server)
  } else {
    window.location.href = "https://chadd-cod07.github.io/km6-login/km6-dashboard/index.html"; // GitHub
  }
});

function handleFile(event) {
  const file = event.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = function (e) {
    const data = new Uint8Array(e.target.result);
    const workbook = XLSX.read(data, { type: 'array' });

    // âœ… Try reading both sheets
    const sheetGross = workbook.Sheets["Gross"];
    const sheetNet = workbook.Sheets["P_Net.Inv"];

    if (!sheetNet) {
      alert("âš ï¸ Missing sheet: 'P_Net.Inv'");
      return;
    }
    if (!sheetGross) {
      alert("âš ï¸ Missing sheet: 'Gross'");
      return;
    }

    // === Convert both sheets to JSON ===
    const grossRows = XLSX.utils.sheet_to_json(sheetGross);
    const netRows = XLSX.utils.sheet_to_json(sheetNet);

    // === Helper for flexible matching ===
    const getVal = (row, names) => {
      const lower = Object.keys(row).reduce((acc, k) => {
        acc[k.toLowerCase().trim()] = row[k];
        return acc;
      }, {});
      for (let name of names) {
        const key = name.toLowerCase().trim();
        if (lower[key] !== undefined && lower[key] !== "")
          return parseFloat(String(lower[key]).replace(/,/g, "")) || 0;
      }
      return 0;
    };

    // === Initialize totals ===
    let totals = {
      KM6: { gross: 0, reject: 0, bo: 0, net: 0 },
      KML: { gross: 0, reject: 0, bo: 0, net: 0 }
    };

    // âœ… Get Gross totals from â€œGrossâ€ sheet
    grossRows.forEach(r => {
      const branch = String(r["Branch Name"] || "").toUpperCase();
      const val = getVal(r, ["Sum of Order Amount", "GROSS", "TOTAL GROSS", "TOTAL INVOICE"]);

      if (branch.includes("BAGUIO") || branch.includes("KM6")) {
        totals.KM6.gross += val;
      } else if (branch.includes("LA UNION") || branch.includes("KML")) {
        totals.KML.gross += val;
      }
    });

    // âœ… Get Rejection, BO, Net from â€œP_Net.Invâ€ sheet
    netRows.forEach(r => {
      const branch = String(r["Branch Name"] || "").toUpperCase();
      const reject = getVal(r, ["REJECTION", "TOTAL REJECTION", "REJ"]);
      const bo = getVal(r, ["BO", "TOTAL BO", "B.O.", "B.O AMOUNT"]);
      const net = getVal(r, ["NET", "TOTAL NET", "NET SALES"]);

      if (branch.includes("BAGUIO") || branch.includes("KM6")) {
        totals.KM6.reject += reject;
        totals.KM6.bo += bo;
        totals.KM6.net += net;
      } else if (branch.includes("LA UNION") || branch.includes("KML")) {
        totals.KML.reject += reject;
        totals.KML.bo += bo;
        totals.KML.net += net;
      }
    });

    // âœ… Save data
    localStorage.setItem("dashboardTotals", JSON.stringify(totals));

    // âœ… Display results
    document.getElementById("result").innerHTML = `
      <h3>âœ… Data Uploaded Successfully</h3>

      <p><strong>KM6 (Baguio)</strong><br>
        Gross: ${totals.KM6.gross.toLocaleString()}<br>
        Rejection: ${totals.KM6.reject.toLocaleString()}<br>
        BO: ${totals.KM6.bo.toLocaleString()}<br>
        Net: ${totals.KM6.net.toLocaleString()}</p>

      <p><strong>KML (La Union)</strong><br>
        Gross: ${totals.KML.gross.toLocaleString()}<br>
        Rejection: ${totals.KML.reject.toLocaleString()}<br>
        BO: ${totals.KML.bo.toLocaleString()}<br>
        Net: ${totals.KML.net.toLocaleString()}</p>

      <p><em>Click "Go Back to Dashboard" to refresh data.</em></p>
    `;
    document.getElementById("backButton").style.display = "inline-block";
  };

  reader.readAsArrayBuffer(file);
}
</script>

</body>
</html>
