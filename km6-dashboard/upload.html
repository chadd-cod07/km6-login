<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Upload Excel File - KM6 Dashboard</title>
  <link rel="stylesheet" href="style.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; background-color: #f6f8fa; text-align: center; padding: 50px; }
    h2 { color: #00843d; }
    input[type="file"] {
      padding: 10px; border: 2px dashed #00843d; border-radius: 10px; background: #fff; cursor: pointer; margin-top: 20px;
    }
    .result {
      margin-top: 30px; background: #fff; padding: 20px; border-radius: 10px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1); display: inline-block; text-align: left; width: 360px;
    }
    button { background-color: #00843d; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin-top: 20px; }
    button:hover { background-color: #006f32; }
    .ok { color: #00843d; font-weight: bold; }
  </style>
</head>
<body>

  <h2>üìä Upload Excel File to Update Dashboard</h2>
  <p>Select your latest <strong>dataweb.xlsx</strong> file below:</p>
  <input type="file" id="fileInput" accept=".xlsx, .xls" />

  <div class="result" id="result"></div>

  <button id="backButton" style="display:none;">Go Back to Dashboard</button>

<script>
document.getElementById('fileInput').addEventListener('change', handleFile, false);

document.getElementById('backButton').addEventListener('click', () => {
  if (window.location.hostname === "127.0.0.1" || window.location.hostname === "localhost") {
    window.location.href = "index.html";
  } else {
    window.location.href = "https://chadd-cod07.github.io/km6-login/km6-dashboard/index.html";
  }
});

function handleFile(event) {
  const file = event.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = function (e) {
    const data = new Uint8Array(e.target.result);
    const workbook = XLSX.read(data, { type: 'array' });

    const sheetGross = workbook.Sheets["Gross"];
    const sheetNet = workbook.Sheets["P_Net.Inv"];
    if (!sheetGross || !sheetNet) {
      alert("‚ùå Missing sheet(s): please ensure both 'Gross' and 'P_Net.Inv' exist.");
      return;
    }

    const grossRows = XLSX.utils.sheet_to_json(sheetGross);
    const netRows = XLSX.utils.sheet_to_json(sheetNet);

    // Utility: normalize keys
    const normalizeKeys = (row) => {
      const obj = {};
      for (const k in row) {
        obj[k.toLowerCase().trim().replace(/\s+/g, " ")] = row[k];
      }
      return obj;
    };

    const getVal = (row, keys) => {
      const r = normalizeKeys(row);
      for (const k of keys) {
        const key = k.toLowerCase().trim().replace(/\s+/g, " ");
        if (r[key] !== undefined && r[key] !== "") {
          const v = parseFloat(String(r[key]).replace(/,/g, ""));
          if (!isNaN(v)) return v;
        }
      }
      return 0;
    };

    const getText = (row, keys) => {
      const r = normalizeKeys(row);
      for (const k of keys) {
        const key = k.toLowerCase().trim().replace(/\s+/g, " ");
        if (r[key] !== undefined && r[key] !== null) return String(r[key]).trim();
      }
      return "";
    };

    const totals = {
      KM6: { gross: 0, reject: 0, bo: 0, net: 0 },
      KML: { gross: 0, reject: 0, bo: 0, net: 0 }
    };

    const fsTotals = {};

    // === Process "Gross" sheet
    grossRows.forEach(r => {
      const branch = getText(r, ["Branch Name"]).toUpperCase();
      const fs = getText(r, ["fs", "FS", "Salesman", "Employee Name"]);
      const gross = getVal(r, ["Sum of Order Amount", "GROSS", "TOTAL INVOICE"]);

      if (!fs) return;
      const key = fs.toUpperCase();
      if (!fsTotals[key]) fsTotals[key] = { gross: 0, reject: 0, bo: 0, net: 0 };
      fsTotals[key].gross += gross;

      if (branch.includes("KM6") || branch.includes("BAGUIO")) totals.KM6.gross += gross;
      if (branch.includes("KML") || branch.includes("LA UNION")) totals.KML.gross += gross;
    });

    // === Process "P_Net.Inv" sheet
    netRows.forEach(r => {
      const branch = getText(r, ["Branch Name"]).toUpperCase();
      const fs = getText(r, ["fs", "FS", "Salesman", "Employee Name"]);
      const reject = getVal(r, ["TOTAL REJECTION", "REJECTION"]);
      const bo = getVal(r, ["TOTAL BO", "BO", "B.O AMOUNT"]);
      const net = getVal(r, ["TOTAL NET", "NET SALES", "NET"]);

      if (!fs) return;
      const key = fs.toUpperCase();
      if (!fsTotals[key]) fsTotals[key] = { gross: 0, reject: 0, bo: 0, net: 0 };
      fsTotals[key].reject += reject;
      fsTotals[key].bo += bo;
      fsTotals[key].net += net;

      if (branch.includes("KM6") || branch.includes("BAGUIO")) {
        totals.KM6.reject += reject;
        totals.KM6.bo += bo;
        totals.KM6.net += net;
      }
      if (branch.includes("KML") || branch.includes("LA UNION")) {
        totals.KML.reject += reject;
        totals.KML.bo += bo;
        totals.KML.net += net;
      }
    });

    // ‚úÖ Debug: show what‚Äôs captured
    console.log("üìä Branch Totals:", totals);
    console.log("üë§ FS Totals:", fsTotals);

    localStorage.setItem("dashboardTotals", JSON.stringify(totals));
    localStorage.setItem("fsTotals", JSON.stringify(fsTotals));

    const fmt = n => Number(n || 0).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 3 });
    document.getElementById("result").innerHTML = `
      <h3>‚úÖ Data Uploaded Successfully</h3>
      <p><strong>KM6 (Baguio)</strong><br>
      Gross: ${fmt(totals.KM6.gross)}<br>
      Rejection: ${fmt(totals.KM6.reject)}<br>
      BO: ${fmt(totals.KM6.bo)}<br>
      Net: ${fmt(totals.KM6.net)}</p>
      <p><strong>KML (La Union)</strong><br>
      Gross: ${fmt(totals.KML.gross)}<br>
      Rejection: ${fmt(totals.KML.reject)}<br>
      BO: ${fmt(totals.KML.bo)}<br>
      Net: ${fmt(totals.KML.net)}</p>
      <p><em>Click "Go Back to Dashboard" to refresh data.</em></p>
    `;
    document.getElementById("backButton").style.display = "inline-block";
  };
  reader.readAsArrayBuffer(file);
}
</script>
<!-- === Firebase Cloud Save (Safe for GitHub Pages) === -->
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore-compat.js"></script>
<script>
  // Initialize Firebase (only once)
  const firebaseConfig = {
    apiKey: "AIzaSyCStpCWdRO770N4SpH3GKYwp9pg1kP6_O4",
    authDomain: "km6-dashboard.firebaseapp.com",
    projectId: "km6-dashboard",
    storageBucket: "km6-dashboard.firebasestorage.app",
    messagingSenderId: "309068846407",
    appId: "1:309068846407:web:68d51a21f6ab238fa1a862"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // Replace local-only saving with dual cloud save
  async function saveToFirebase(totals, fsTotals) {
    try {
      await db.collection("km6_dashboard_data").doc("dashboardTotals").set(totals);
      await db.collection("km6_dashboard_data").doc("fsTotals").set(fsTotals);
      console.log("‚òÅÔ∏è Data successfully synced to Firebase.");
    } catch (error) {
      console.error("‚ùå Firebase upload failed:", error);
    }
  }

  // Hook into your existing save step
  const originalHandleFile = handleFile;
  handleFile = async function (event) {
    await originalHandleFile(event);

    // After localStorage saves, send to Firebase too
    try {
      const totals = JSON.parse(localStorage.getItem("dashboardTotals"));
      const fsTotals = JSON.parse(localStorage.getItem("fsTotals"));
      if (totals && fsTotals) {
        await saveToFirebase(totals, fsTotals);
      }
    } catch (err) {
      console.warn("‚ö†Ô∏è Firebase sync skipped:", err);
    }
  };
</script>

</body>
</html>
